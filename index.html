<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÁΩóÂ§èÂ¢®ËøπÊµãËØï-ÂõæÁâà</title>
    <style>
        :root {
            --primary-color: #1e3a8a;
            --primary-light: #3b82f6;
            --primary-lighter: #dbeafe;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 20px 25px rgba(0, 0, 0, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: var(--bg-gradient);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            user-select: none;
            overflow: hidden;
        }

        /* Â±èÂπïÂàáÊç¢ */
        .screen {
            display: none;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
        }

        #info-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            background: var(--bg-gradient);
        }

        .info-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 50px 40px;
            box-shadow: var(--shadow-lg);
            max-width: 450px;
            width: 100%;
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .info-card h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
            font-weight: 700;
        }

        .info-form-group {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
        }

        .info-form-group label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }

        .info-form-group input {
            padding: 12px 14px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #f9fafb;
        }

        .info-form-group input:focus {
            outline: none;
            border-color: var(--primary-light);
            background: white;
            box-shadow: 0 0 0 3px var(--primary-lighter);
        }

        #start-test-btn {
            width: 100%;
            padding: 14px;
            margin-top: 30px;
            background: var(--primary-light);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
        }

        #start-test-btn:hover {
            background: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        #start-test-btn:active {
            transform: translateY(0);
        }

        #enter-btn {
            padding: 8px 28px;
            margin-top: 10px;
            background: var(--primary-light);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }
        /* Â∫îÁî®Á™óÂè£ */
        .app-window {
            display: flex;
            flex-direction: column;
            width: 95vw;
            max-width: 1200px;
            height: 95vh;
            max-height: 900px;
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }

        .title-bar {
            background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
            color: white;
            padding: 16px 24px;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }

        .progress-info {
            font-size: 14px;
            opacity: 0.9;
        }

        .main-content {
            flex: 1;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background: #fafafa;
        }

        #intro-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.95) 100%);
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 30px;
            box-sizing: border-box;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        #intro-image {
            max-width: 300px;
            max-height: 300px;
            object-fit: contain;
            margin-bottom: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
        }

        #intro-text {
            font-size: 15px;
            line-height: 1.8;
            max-width: 700px;
            text-align: left;
            color: var(--text-primary);
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            max-height: 40vh;
            overflow-y: auto;
        }

        #image-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }

        #rorschach-image {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 8px;
            transition: transform 0.2s ease-out;
        }

        #drawing-canvas {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            cursor: crosshair;
            max-width: 90%;
            max-height: 90%;
        }

        /* ÂêéÊµãËØïËßÜÂõæ */
        #post-test-view,
        #summary-view {
            padding: 30px;
            overflow-y: auto;
            height: 100%;
            background: var(--card-bg);
            box-sizing: border-box;
        }

        #post-test-view h2,
        #summary-view h2 {
            text-align: center;
            margin-bottom: 25px;
            color: var(--primary-color);
            font-size: 24px;
            font-weight: 700;
        }

        #question-text {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            text-align: center;
            min-height: 40px;
            margin-bottom: 30px;
            padding: 15px;
            background: var(--primary-lighter);
            border-radius: 10px;
            animation: slideUp 0.3s ease-out;
        }

        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .grid-item {
            border: 3px solid var(--border-color);
            border-radius: 12px;
            padding: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            overflow: hidden;
        }

        .grid-item:hover {
            border-color: var(--primary-light);
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }

        .grid-item.selected {
            border-color: var(--success-color);
            background: linear-gradient(135deg, rgba(16,185,129,0.1) 0%, rgba(16,185,129,0.05) 100%);
            box-shadow: 0 0 0 3px rgba(16,185,129,0.2);
            transform: scale(1.05);
        }

        .grid-item img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            display: block;
        }

        .grid-item h4 {
            margin-top: 8px;
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .summary-grid {
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        }

        .summary-item {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            background: white;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
        }

        .summary-item:hover {
            box-shadow: var(--shadow-md);
        }

        .summary-item h4 {
            margin-bottom: 12px;
            color: var(--primary-color);
            font-weight: 600;
        }

        .summary-item img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        /* ÊéßÂà∂Ê†è */
        .controls-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 16px;
            border-top: 2px solid var(--border-color);
            background: linear-gradient(90deg, #f8fafc 0%, #f0f9ff 100%);
            flex-wrap: wrap;
            gap: 12px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            padding: 8px 12px;
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
        }

        .control-group button {
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s ease;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .control-group button:hover {
            border-color: var(--primary-light);
            background: var(--primary-lighter);
            color: var(--primary-color);
        }

        .control-group button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .control-group button.selected {
            background: var(--primary-light);
            border-color: var(--primary-color);
            color: white;
            box-shadow: 0 0 0 3px var(--primary-lighter);
        }

        .color-selector {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .color-option {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
        }

        .color-option:hover {
            transform: scale(1.15);
        }

        .color-option.selected {
            border-color: #333;
            box-shadow: 0 0 0 2px white, 0 0 0 4px #333;
        }

        #finish-btn {
            padding: 12px 28px;
            margin-top: 25px;
            background: var(--success-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
        }

        #finish-btn:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* ÊèêÁ§∫ÊåáÁ§∫Âô® */
        .prompt-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--warning-color);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            animation: slideInUp 0.3s ease-out;
            box-shadow: var(--shadow-lg);
            z-index: 200;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ÂìçÂ∫îÂºè */
        @media (max-width: 768px) {
            .info-card {
                padding: 30px 20px;
            }

            .image-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 10px;
            }

            .summary-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }

            .controls-bar {
                gap: 8px;
            }

            .control-group {
                padding: 6px 8px;
                font-size: 12px;
            }

            .control-group button {
                padding: 6px 10px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>

    <!-- ‰ø°ÊÅØËæìÂÖ•Â±èÂπï -->
    <div id="info-screen" class="screen">
        <div class="info-card">
            <h1>üé® ÁΩóÂ§èÂ¢®ËøπÊµãËØï</h1>
            <div class="info-form-group">
                <label for="age">Âπ¥ÈæÑ</label>
                <input type="text" id="age" placeholder="‰æãÂ¶ÇÔºö25">
            </div>
            <div class="info-form-group">
                <label for="education">Â≠¶ÂéÜ</label>
                <input type="text" id="education" placeholder="‰æãÂ¶ÇÔºöÊú¨Áßë">
            </div>
            <div class="info-form-group">
                <label for="occupation">ËÅå‰∏ö</label>
                <input type="text" id="occupation" placeholder="‰æãÂ¶ÇÔºöÂ∑•Á®ãÂ∏à">
            </div>
            <div class="info-form-group">
                <label for="mood">ÂΩìÂâçÂøÉÊÉÖ</label>
                <input type="text" id="mood" placeholder="‰æãÂ¶ÇÔºöÂπ≥Èùô">
            </div>
            <button id="start-test-btn">ÂºÄÂßãÊµãËØï</button>
        </div>
    </div>

    <!-- ‰∏ªÂ∫îÁî®Á™óÂè£ -->
    <div id="app-window" class="app-window screen">
        <div class="title-bar">
            <span>üé® ÁΩóÂ§èÂ¢®ËøπÊµãËØï</span>
            <span class="progress-info" id="progress-text">ÂáÜÂ§á‰∏≠...</span>
        </div>

        <div class="main-content" id="main-content">
            <div id="intro-overlay">
                <img id="intro-image" src="./images/rorschach-blot-example.png" alt="‰ªãÁªç">
                <p id="intro-text"></p>
                <button id="enter-btn" style="display: none;">ËøõÂÖ•</button>
            </div>
            <div id="image-container">
                <img id="rorschach-image" src="" alt="ÁΩóÂ§èÂ¢®ËøπÂõæ">
                <canvas id="drawing-canvas"></canvas>
            </div>
        </div>

        <div id="post-test-view" style="display: none;">
            <h2>üìä ÊµãËØïÊÄªÁªì‰∏éÂèçÊÄù</h2>
            <p id="question-text"></p>
            <div id="post-test-grid" class="image-grid"></div>
            <button id="finish-btn" style="display: none;">‚úÖ ÂÆåÊàêÊµãËØïÂπ∂Êü•ÁúãÊ±áÊÄª</button>
        </div>

        <div id="summary-view" style="display: none;">
            <h2>üìà ÂÆåÊï¥ÊµãËØïÊ±áÊÄª</h2>
            <div id="summary-grid" class="image-grid"></div>
        </div>

        <div class="controls-bar" id="controls-bar" style="display: none;">
            <div class="control-group">
                <button id="prev-btn">‚óÄ ‰∏ä‰∏ÄÂº†</button>
            </div>
            <div class="control-group">
                <button id="zoom-in-btn">üîç+ ÊîæÂ§ß</button>
                <button id="zoom-out-btn">üîç- Áº©Â∞è</button>
                <button id="rotate-left-btn">‚Ü∂ Â∑¶ËΩ¨</button>
                <button id="rotate-right-btn">‚Ü∑ Âè≥ËΩ¨</button>
            </div>
            <div class="control-group">
                <button id="pen-tool" class="selected">‚úèÔ∏è ÁîªÁ¨î</button>
                <div class="color-selector">
                    <div class="color-option selected" data-color="red" style="background-color: #ef4444;"></div>
                    <div class="color-option" data-color="green" style="background-color: #10b981;"></div>
                    <div class="color-option" data-color="blue" style="background-color: #3b82f6;"></div>
                </div>
                <button id="eraser-tool">üóëÔ∏è Êì¶Èô§</button>
            </div>
            <div class="control-group">
                <button id="next-btn">‰∏ã‰∏ÄÂº† ‚ñ∂</button>
            </div>
        </div>
    </div>

    <audio id="audio-player"></audio>

    <!-- Axios Â∫ì -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <!-- ‰∫§‰∫íËøΩË∏™Á≥ªÁªü -->
    <script type="module" src="./script/interactionTracker.js"></script>
    
    <!-- API Êé•Âè£Ê®°Âùó -->
    <script type="module" src="./script/api.js"></script>
    
    <!-- TTS ËØ≠Èü≥ÂêàÊàêÂÆ¢Êà∑Á´Ø -->
    <script type="module" src="./script/ttsClient.js"></script>

    <script>
        const state = {
            currentIndex: 0,
            totalImages: 10,
            zoom: 1,
            rotation: 0,
            drawing: false,
            tool: 'pen',
            color: 'red',
            canvasStates: new Array(10).fill(null),
            isSpeaking: false,
            mediaRecorder: null,
            audioChunks: [],
            audioBlob: null,  // ‰øùÂ≠òÂÆåÊï¥ÁöÑÈü≥È¢ëBlobÔºå‰æõÊé•Âè£Êèê‰∫§‰ΩøÁî®
            postTestAnswers: {},
            inactivityLevel: 0,
            nextButtonCooldown: 0  // "‰∏ã‰∏ÄÂº†"ÊåâÈíÆÂÜ∑Âç¥Êó∂Èó¥ÔºàÁßíÔºâ
        };
        
        // Â∞Ü state ÊåÇËΩΩÂà∞ window ÂØπË±°Ôºå‰ª•‰æø InteractionTracker ÂèØ‰ª•ËÆøÈóÆ
        window.state = state;

        let inactivityTimer = null;
        let nextButtonCooldownTimer = null;  // "‰∏ã‰∏ÄÂº†"ÊåâÈíÆÂÜ∑Âç¥ÂÆöÊó∂Âô®
        const INACTIVITY_THRESHOLD_1 = 4000;  // Á¨¨‰∏ÄÊ¨°ÊèêÁ§∫
        const INACTIVITY_THRESHOLD_2 = 8000;  // Á¨¨‰∫åÊ¨°ÊèêÁ§∫
        const NEXT_BUTTON_COOLDOWN = 30;  // "‰∏ã‰∏ÄÂº†"ÊåâÈíÆÂÜ∑Âç¥Êó∂Èó¥ÔºàÁßíÔºâ
        // ÊèêÁ§∫ÊñáÊú¨Êï∞ÁªÑÔºàÁî®‰∫éTTSËØ≠Èü≥ÂêàÊàêÔºâ
        const PROMPT_TEXTS = [
            'ÊèêÁ§∫ÔºöËØ∑ÁªßÁª≠ÊèèËø∞...',
            'ÊÇ®ËøòËÉΩÁúãÂà∞‰∫õ‰ªÄ‰πàÂêóÔºü',
            'ËØ∑ËØ¶ÁªÜÊèèËø∞‰∏Ä‰∏ãÊÇ®ÁúãÂà∞ÁöÑÂÜÖÂÆπ',
            'Èô§‰∫ÜËøô‰∏™ÔºåÊÇ®ËøòËÉΩÁúãÂà∞‰ªÄ‰πàÔºü',
            'ËØ∑ÁªßÁª≠ÂàÜ‰∫´ÊÇ®ÁöÑËßÇÂØü',
            'ÊÇ®ÂèØ‰ª•Êõ¥ËØ¶ÁªÜÂú∞ÊèèËø∞‰∏Ä‰∏ãÂêóÔºü'
        ];
        const FINAL_PROMPT_TEXT = 'ÊèêÁ§∫ÔºöËØ∑ÁÇπÂáª‰∏ã‰∏ÄÂº†ÂõæÁâáÁªßÁª≠...';
        
        const POST_TEST_QUESTIONS = [
            { key: 'represent', text: 'ÂçÅÂº†ÂõæÁâáÈáåÔºåÈÄâÊã©‰∏ÄÂº†ÊúÄËÉΩ‰ª£Ë°®‰Ω†ÁöÑ„ÄÇ', audio: './audio/q_represent.wav' },
            { key: 'mother', text: 'ÂçÅÂº†ÂõæÁâáÈáåÔºåÈÄâÊã©‰∏ÄÂº†ÊúÄËÉΩ‰ª£Ë°®‰Ω†ÊØç‰∫≤ÁöÑ„ÄÇ', audio: './audio/q_mother.wav' },
            { key: 'father', text: 'ÂçÅÂº†ÂõæÁâáÈáåÔºåÈÄâÊã©‰∏ÄÂº†ÊúÄËÉΩ‰ª£Ë°®‰Ω†Áà∂‰∫≤ÁöÑ„ÄÇ', audio: './audio/q_father.wav' },
            { key: 'like', text: 'ÂçÅÂº†ÂõæÁâáÈáåÔºå‰Ω†ÊúÄÂñúÊ¨¢Âì™‰∏ÄÂº†Ôºü', audio: './audio/q_like.wav' },
            { key: 'dislike', text: 'ÂçÅÂº†ÂõæÁâáÈáåÔºå‰Ω†ÊúÄËÆ®ÂéåÂì™‰∏ÄÂº†Ôºü', audio: './audio/q_dislike.wav' },
            { key: 'mood', text: 'ÊµãËØïÂà∞Ê≠§‰∏∫Ê≠¢‰∫ÜÔºå‰Ω†Áé∞Âú®ÂøÉÊÉÖÂ¶Ç‰ΩïÔºüÁõ∏ÊØîÂàöÂºÄÂßãÊµãËØïÊó∂Ôºü', audio: './audio/q_mood.wav' }
        ];
        
        let currentQuestionIndex = 0;

        // ‰ºöËØùÁ∫ß TTS ËÆæÁΩÆÔºàÂèØÊåâÈúÄÊîπ‰∏∫‰ªé UI/ÈÖçÁΩÆËØªÂèñÔºâ
        const TTS = {
            speaker: 'zh_female_vv_jupiter_bigtts',
            inited: false,
            currentMode: null
        };

        if (window.dialogClient) {
            window.dialogClient.onDisconnect = () => {
                TTS.inited = false;
                TTS.currentMode = null;
            };
        }

        // ÂêØÂä®È°µ‰ªãÁªçÊñáÊ°àÔºàÁî®‰∫éÊòæÁ§∫‰∏éÊí≠Êä•‰øùÊåÅ‰∏ÄËá¥Ôºâ
        const INTRO_TEXT = `ÁΩóÂ§èÂ¢®ËøπÊòØÁëûÂ£´ÂøÉÁêÜÂ≠¶ÂÆ∂ÂèëÊòéÁöÑ‰∏ÄÁßçÊäïÂ∞ÑÊ≥ïÂøÉÁêÜÊµãËØïÊñπÊ≥ï„ÄÇÊàë‰ºö‰æùÊ¨°Áªô‰Ω†Â±ïÁ§∫ÂçÅÂº†Â¢®ËøπÁöÑÂõæÁâáÔºåËøô‰∫õÂ¢®ËøπÁÇπÁöÑÁªòÂà∂ÈÉΩÊòØÈöèÊú∫ÁöÑÔºå‰πüÊòØÊäΩË±°ÁöÑÔºåÊØè‰∏™‰∫∫ÁúãÂà∞ÁöÑÂÜÖÂÆπÈÉΩ‰∏çÂêå„ÄÇ

‰Ω†Ë¶ÅÂÅöÁöÑÂ∞±ÊòØÂëäËØâÊàëÔºå‰Ω†‰ªéÂõæÁâá‰∏≠ÁúãÂà∞‰∫Ü‰ªÄ‰πàÔºåÂπ∂‰∏îÊèèËø∞‰∏Ä‰∏ã‰Ω†ÊâÄÁúãÂà∞ÁöÑ‰∏úË•ø„ÄÅËÅîÊÉ≥Âà∞ÁöÑ‰∏úË•ø„ÄÇ‰∏çÁÆ°ÁúãËßÅ‰ªÄ‰πàÔºåÈÉΩÂèØ‰ª•Ë°®Ëø∞ÂõûÁ≠îÔºåÊ≤°Êúâ‰ªÄ‰πàÊ≠£Á°Æ„ÄÅÈîôËØØÁöÑÂõûÁ≠î„ÄÇ

‰Ω†ÂèØ‰ª•ËßÇÂØü‰∏Ä‰∏ãËøô‰∏™ËΩØ‰ª∂ÁïåÈù¢‰∏äÁöÑÂêÑÁßçÊåâÈíÆÔºåÂú®ÊµãËØïÁöÑÊó∂ÂÄôÂèØ‰ª•Ê†πÊçÆËá™Â∑±ÁöÑÈúÄË¶ÅËøõË°åË∞ÉÊï¥ËßÇÂØüÂõæÁâáÁöÑËßÜËßíÔºåÊØîÂ¶ÇÊîæÂ§ß„ÄÅÁº©Â∞è„ÄÅÊóãËΩ¨ÂõæÁâáÔºåËøòÂèØ‰ª•Âú®ÊèèËø∞ÁöÑÊó∂ÂÄô‰ΩøÁî®ÁîªÁ¨îÊù•ÂãæÁîªÁ≠âÁ≠â„ÄÇ

ÊÄª‰πãÔºåËßÇÁúãÁêÜËß£ÂõæÁâáÔºå‰∏çÂèó‰ªª‰ΩïÈôêÂà∂„ÄÇÊµãËØïËøáÁ®ã‰∏≠ÔºåÊàë‰∏ç‰ºöËØ¢ÈóÆ‰Ω†ÁöÑÈöêÁßÅ‰ø°ÊÅØÔºåÊâÄ‰ª•ÂÆâÂÖ®ÊÄß‰Ω†ÂèØ‰ª•ÊîæÂøÉ„ÄÇ`;

        async function ensureTTSInit(mode = 'audio') {
            if (!window.dialogClient) {
                throw new Error('dialogClient Êú™Âä†ËΩΩ');
            }
            if (window.dialogClient.isConnected) {
                if (TTS.inited && TTS.currentMode === mode) {
                    return;
                }
                // Ê®°Âºè‰∏çÂêåÔºöÊñ≠ÂºÄÈáçËøû
                window.dialogClient.disconnect();
                TTS.inited = false;
                TTS.currentMode = null;
                // Á≠âÂæÖÁü≠ÊöÇÊó∂Èó¥ËÆ©ËøûÊé•ÂÖ≥Èó≠
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            if (!window.dialogClient.isConnected) {
                await window.dialogClient.connect();
            }
            try {
                const initMsg = JSON.stringify({ type: 'init', speaker: TTS.speaker, mode });
                window.dialogClient.ws && window.dialogClient.ws.send(initMsg);
                TTS.inited = true;
                TTS.currentMode = mode;
            } catch (e) {
                console.warn('ÂèëÈÄÅ TTS ÂàùÂßãÂåñÂ§±Ë¥•Ôºö', e);
            }
        }

        async function sendTTSText(text, opts = { start: true, end: true, is_user_querying: false }) {
            if (!window.dialogClient) {
                throw new Error('dialogClient Êú™Âä†ËΩΩ');
            }
            if (!window.dialogClient.isConnected) {
                await window.dialogClient.connect();
            }
            const msg = JSON.stringify({
                type: 'tts_text',
                start: Boolean(opts.start),
                end: Boolean(opts.end),
                is_user_querying: Boolean(opts.is_user_querying),
                content: String(text || '')
            });
            window.dialogClient.ws && window.dialogClient.ws.send(msg);
        }

        async function sendTextQuery(text, { ensure = true } = {}) {
            if (!window.dialogClient) {
                throw new Error('dialogClient Êú™Âä†ËΩΩ');
            }
            if (ensure) {
                await ensureTTSInit('audio');
            } else if (!window.dialogClient.isConnected) {
                await window.dialogClient.connect();
            }
            const msg = JSON.stringify({
                type: 'text_query',
                content: String(text || '')
            });
            window.dialogClient.ws && window.dialogClient.ws.send(msg);
        }

        // DOM Elements
        const infoScreen = document.getElementById('info-screen');
        const appWindow = document.getElementById('app-window');
        const mainContent = document.getElementById('main-content');
        const startTestBtn = document.getElementById('start-test-btn');
        const introOverlay = document.getElementById('intro-overlay');
        const introText = document.getElementById('intro-text');
        const enterBtn = document.getElementById('enter-btn');
        const audioPlayer = document.getElementById('audio-player');
        const controlsBar = document.getElementById('controls-bar');
        const rorschachImage = document.getElementById('rorschach-image');
        const canvas = document.getElementById('drawing-canvas');
        const imageContainer = document.getElementById('image-container');
        const postTestView = document.getElementById('post-test-view');
        const summaryView = document.getElementById('summary-view');
        const questionText = document.getElementById('question-text');
        const finishBtn = document.getElementById('finish-btn');
        const nextBtn = document.getElementById('next-btn');
        const prevBtn = document.getElementById('prev-btn');
        const progressText = document.getElementById('progress-text');
        const ctx = canvas.getContext('2d');

        // ÂêØÂä®ÊµãËØï
        async function startTest() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                initAudio(stream);

                infoScreen.style.display = 'none';
                appWindow.style.display = 'flex';

                introText.textContent = INTRO_TEXT;
                // ÊòæÁ§∫"ËøõÂÖ•"ÊåâÈíÆ
                enterBtn.style.display = 'block';
                enterBtn.disabled = true;
                enterBtn.textContent = 'ËØ≠Èü≥Êí≠Êä•‰∏≠...';

                // Âú®Áî®Êà∑ÁÇπÂáª‚ÄúÂºÄÂßãÊµãËØï‚ÄùÂêéÔºå‰ΩøÁî®ÂÆûÊó∂ TTS Êí≠Êä•ÂêØÂä®È°µ‰ªãÁªç
                try {
                    await ensureTTSInit('audio');
                    const introQuery = `ËØ∑‰ªÖÊúóËØª‰ª•‰∏ãÊñáÊú¨ÂÜÖÂÆπÔºåÈÄêÂ≠óÈÄêÂè•Êí≠Êä•Ôºå‰∏çË¶ÅÊ∑ªÂä†‰ªª‰ΩïÂâçÁºÄÊàñÂêéÁºÄÔºå‰πü‰∏çË¶ÅÊ∑ªÂä†‰ªª‰ΩïÈ¢ùÂ§ñËß£ÈáäÔºå‰øùÊåÅÂéüÊñáÁöÑÊç¢Ë°å‰∏éÂÅúÈ°øÔºö\n${INTRO_TEXT}`;
                    await sendTextQuery(introQuery, { ensure: false });
                } catch (e) {
                    console.warn('[ÂêØÂä®È°µ‰ªãÁªç] Êí≠Êä•Â§±Ë¥•ÔºåÂ∑≤ÂøΩÁï•Ôºö', e);
                    enterBtn.disabled = false;
                    enterBtn.textContent = 'ËøõÂÖ•';
                }

                // Êí≠Êä•ÁªìÊùüÂêéÂÖÅËÆ∏ËøõÂÖ•ÊµãËØï
                const estimatedIntroDuration = Math.min(15000, Math.max(5000, Math.floor(INTRO_TEXT.length * 120)));
                setTimeout(() => {
                    enterBtn.disabled = false;
                    enterBtn.textContent = 'ËøõÂÖ•';
                }, estimatedIntroDuration);
                
                // ÁÇπÂáª"ËøõÂÖ•"ÊåâÈíÆÂêéËøûÊé• WebSocket Âπ∂ÂºÄÂßãÂΩïÈü≥ÔºåÁõ¥Êé•ËøõÂÖ•ÊµãËØïÊµÅÁ®ã
                enterBtn.onclick = async () => {
                    try {
                        enterBtn.disabled = true;
                        enterBtn.textContent = 'ËøûÊé•‰∏≠...';
                        
                        // ËøûÊé•Ë±ÜÂåÖÂÆûÊó∂ËØ≠Èü≥ WebSocket
                        if (window.dialogClient) {
                            await ensureTTSInit('audio');

                            // Á°Æ‰øù‰ª• arraybuffer Êé•Êî∂‰∫åËøõÂà∂ÔºåÂáèÂ∞ë Blob ÂºÄÈîÄ
                            if (window.dialogClient.ws) {
                                try { window.dialogClient.ws.binaryType = 'arraybuffer'; } catch (e) { console.warn('binaryType ËÆæÁΩÆÂ§±Ë¥•:', e); }
                            }
                            // Áî®Êà∑ÊâãÂäø‰∏ãÊòæÂºèËß£ÈîÅ AudioContext
                            if (window.dialogClient.audioContext && window.dialogClient.audioContext.state === 'suspended') {
                                try { await window.dialogClient.audioContext.resume(); } catch (e) { console.warn('AudioContext resume Â§±Ë¥•:', e); }
                            }
                            // Á´ãÂç≥ÂºÄÂêØÂΩïÈü≥Ôºå‰øùÊåÅ‰ºöËØùÊ¥ªË∑ÉÔºåÈÅøÂÖçÊúçÂä°Á´ØËøáÊó©ÁªìÊùü‰ºöËØù
                            try {
                                await window.dialogClient.startRecording();
                            } catch (err) {
                                console.warn('ÂºÄÂßãÂΩïÈü≥Â§±Ë¥•:', err);
                            }
                        }
                        
                        // ÈöêËóè‰ªãÁªçË¶ÜÁõñÂ±ÇÔºåÁõ¥Êé•ËøõÂÖ•ÊµãËØïÊµÅÁ®ã
                        introOverlay.style.display = 'none';
                        controlsBar.style.display = 'flex';
                        updateProgress();
                        
                        if (state.mediaRecorder && state.mediaRecorder.state === 'inactive') {
                            state.mediaRecorder.start();
                        }
                        
                        // ÂêØÂä® InteractionTracker
                        if (window.InteractionTracker) {
                            window.InteractionTracker.start();
                        }
                        
                        initTest();
                    } catch (error) {
                        console.error('ËøûÊé• WebSocket Â§±Ë¥•:', error);
                        alert('ËøûÊé•ËØ≠Èü≥ÊúçÂä°Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÂêéÁ´ØÊúçÂä°Âô®ÊòØÂê¶Â∑≤ÂêØÂä®„ÄÇ');
                        enterBtn.disabled = false;
                        enterBtn.textContent = 'ËøõÂÖ•';
                    }
                };
            } catch (err) {
                console.error("È∫¶ÂÖãÈ£éÊéàÊùÉÂ§±Ë¥•:", err);
                alert("ÈúÄË¶ÅÈ∫¶ÂÖãÈ£éÊùÉÈôêÊâçËÉΩÂºÄÂßãÊµãËØï„ÄÇËØ∑Âà∑Êñ∞È°µÈù¢Âπ∂ÂÖÅËÆ∏ËÆøÈóÆ„ÄÇ");
            }
        }

        function initTest() {
            // ÂàùÂßãÂåñ‰∫§‰∫íËøΩË∏™Âô®
            // Ê≥®ÊÑèÔºöInteractionTracker.start() Â∑≤Âú®ËØ≠Èü≥Êí≠ÊîæÂÆåÊàêÂêéË∞ÉÁî®ÔºåËøôÈáå‰∏çÂÜçÈáçÂ§çË∞ÉÁî®
            if (window.InteractionTracker) {
                window.InteractionTracker.init({
                    autoTrack: true,
                    trackZoom: true,
                    trackRotate: true,
                    trackDrawing: true,
                    trackNavigation: true,
                    includeTimestamp: false
                });
                // InteractionTracker.start() Â∑≤Âú®ËØ≠Èü≥Êí≠ÊîæÂÆåÊàêÁöÑÂõûË∞É‰∏≠Ë∞ÉÁî®
                window.InteractionTracker._updateCurrentPlate(state.currentIndex);
            }
            
            loadImage(state.currentIndex);
            setupEventListeners();
            updateNavButtons();
            
            // Á¨¨‰∏ÄÂº†ÂõæÁâáÊòæÁ§∫ÂêéÔºåÁ´ãÂç≥ÂêØÂä®"‰∏ã‰∏ÄÂº†"ÊåâÈíÆÁöÑÂÜ∑Âç¥Êó∂Èó¥
            // ËøôÊ†∑Á°Æ‰øùÁî®Êà∑‰ªéÁ¨¨‰∏ÄÂº†ÂõæÁâáÂºÄÂßãÂ∞±ÊúâÂÜ∑Âç¥ÈôêÂà∂
            // Ê≥®ÊÑèÔºöÂøÖÈ°ªÂú® updateNavButtons() ‰πãÂêéË∞ÉÁî®Ôºå‰ª•Á°Æ‰øùÂÜ∑Âç¥Áä∂ÊÄÅ‰∏ç‰ºöË¢´Ë¶ÜÁõñ
            if (state.currentIndex === 0) {
                disableNextButton();
            }

            const resizeObserver = new ResizeObserver(() => {
                if (rorschachImage.complete && rorschachImage.naturalWidth > 0) {
                    resizeCanvas();
                    loadCanvasState(state.currentIndex);
                }
            });
            resizeObserver.observe(rorschachImage);

            // ÂàùÂßãÂåñÊó∂ÔºåÂ¶ÇÊûúÂõæÁâáÂ∑≤Âä†ËΩΩÔºåÁ´ãÂç≥Âä†ËΩΩÁîªÂ∏ÉÁä∂ÊÄÅ
            if (rorschachImage.complete) {
                resizeCanvas();
                loadCanvasState(state.currentIndex);
            } else {
                // ÂõæÁâáÂä†ËΩΩÂÆåÊàêÂêéÂä†ËΩΩÁîªÂ∏ÉÁä∂ÊÄÅ
                rorschachImage.onload = () => {
                    resizeCanvas();
                    loadCanvasState(state.currentIndex);
                    // ÁßªÈô§‰∫ã‰ª∂Â§ÑÁêÜÂô®ÔºåÈÅøÂÖç‰∏é loadImage ‰∏≠ÁöÑÂ§ÑÁêÜÂô®ÂÜ≤Á™Å
                    rorschachImage.onload = null;
                };
            }

            resetInactivityTimer();
        }

        function resizeCanvas() {
            canvas.width = rorschachImage.clientWidth;
            canvas.height = rorschachImage.clientHeight;
            canvas.style.width = rorschachImage.clientWidth + 'px';
            canvas.style.height = rorschachImage.clientHeight + 'px';
        }

        // Èü≥È¢ëÂíåËØ≠Èü≥Ê£ÄÊµã
        function initAudio(stream) {
            state.mediaRecorder = new MediaRecorder(stream);
            state.mediaRecorder.ondataavailable = event => state.audioChunks.push(event.data);

            state.mediaRecorder.onstop = () => {
                const audioBlob = new Blob(state.audioChunks, { type: 'audio/webm' });
                
                // ‰øùÂ≠òÈü≥È¢ëBlobÂà∞stateÔºå‰æõfinishAndSave‰ΩøÁî®
                state.audioBlob = audioBlob;
                
                const audioUrl = URL.createObjectURL(audioBlob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = audioUrl;
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                a.download = `rorschach_recording_${timestamp}.webm`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(audioUrl);
                state.audioChunks = [];
            };

            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const analyser = audioContext.createAnalyser();
            analyser.fftSize = 512;
            const source = audioContext.createMediaStreamSource(stream);
            source.connect(analyser);
            const dataArray = new Uint8Array(analyser.frequencyBinCount);

            function checkSpeaking() {
                analyser.getByteFrequencyData(dataArray);
                let sum = dataArray.reduce((a, b) => a + b, 0);
                if (sum / dataArray.length > 10) {
                    state.isSpeaking = true;
                    resetInactivityTimer();
                } else {
                    state.isSpeaking = false;
                }
                requestAnimationFrame(checkSpeaking);
            }
            checkSpeaking();
        }

        /**
         * Êí≠ÊîæÈü≥È¢ëÔºàÊîØÊåÅÊñá‰ª∂Ë∑ØÂæÑÂíåÂÆûÊó∂ÂØπËØùÊñáÊú¨Ôºâ
         * @param {string} src - Èü≥È¢ëÊñá‰ª∂Ë∑ØÂæÑÔºàÂ¶Ç 'audio/1.mp3'ÔºâÊàñÊñáÊú¨ÂÜÖÂÆπ
         * @param {Function} onendedCallback - Êí≠ÊîæÂÆåÊàêÂõûË∞É
         * @param {Object} options - ÂèØÈÄâÂèÇÊï∞
         */
        async function playAudio(src, onendedCallback = null, options = {}) {
            // Â¶ÇÊûú src ÊòØÊñá‰ª∂Ë∑ØÂæÑÔºà‰ª• './audio/' Êàñ 'audio/' ÂºÄÂ§¥ÔºâÔºå‰ΩøÁî®ÂéüÊúâÊñπÂºèÊí≠Êîæ
            if (typeof src === 'string' && (src.startsWith('./audio/') || src.startsWith('audio/'))) {
                audioPlayer.src = src;
                audioPlayer.onended = onendedCallback;
                audioPlayer.play().catch(e => console.error("Èü≥È¢ëÊí≠ÊîæÂ§±Ë¥•:", e));
                return;
            }

            // Âê¶Âàô‰ΩøÁî®ÂÆûÊó∂ÂØπËØùÂÆ¢Êà∑Á´ØÂèëÈÄÅÊñáÊú¨Êü•ËØ¢
            if (window.dialogClient) {
                try {
                    if (!window.dialogClient.isConnected || TTS.currentMode !== 'audio') {
                        await ensureTTSInit('audio');
                    }
                    // Á°Æ‰øùÂ∑≤ËøûÊé•
                    if (!window.dialogClient.isConnected) {
                        await window.dialogClient.connect();
                    }

                    // ÂèëÈÄÅÊñáÊú¨Êü•ËØ¢ÔºàÂ∑≤Ê≥®ÈáäÔºâ
                    // await window.dialogClient.sendTextQuery(src);

                    // Áî±‰∫éÂÆûÊó∂ÂØπËØùÊòØÊµÅÂºèÊí≠ÊîæÔºåÊó†Ê≥ïÂáÜÁ°ÆÂà§Êñ≠Êí≠ÊîæÂÆåÊàêÊó∂Èó¥
                    // Ê†πÊçÆÊñáÊú¨ÈïøÂ∫¶‰º∞ÁÆóÊí≠ÊîæÊó∂Èó¥ÔºàÂπ≥ÂùáËØ≠ÈÄüÁ∫¶ 3-4 Â≠ó/ÁßíÔºâ
                    if (onendedCallback) {
                        const estimatedDuration = Math.max(2000, src.length * 300); // Ëá≥Â∞ë 2 ÁßíÔºåÊØèÂ≠óÁ∫¶ 300ms
                        setTimeout(() => {
                            if (onendedCallback) {
                                onendedCallback();
                            }
                        }, estimatedDuration);
                    }
                } catch (error) {
                    console.error('[Êí≠ÊîæÈü≥È¢ë] ÂÆûÊó∂ÂØπËØùÂ§±Ë¥•:', error);
                    // ÈîôËØØÂ§ÑÁêÜÔºöÊòæÁ§∫ÊñáÊú¨Êàñ‰ΩøÁî®ÂÖ∂‰ªñÈôçÁ∫ßÊñπÊ°à
                    if (options.onError) {
                        options.onError(error);
                    } else {
                        // ÈôçÁ∫ßÊñπÊ°àÔºöÊòæÁ§∫ÊñáÊú¨ÂÜÖÂÆπ
                        console.warn('[Êí≠ÊîæÈü≥È¢ë] Êó†Ê≥ïÊí≠ÊîæÔºåÊñáÊú¨ÂÜÖÂÆπ:', src);
                    }
                }
            } else {
                console.warn('[Êí≠ÊîæÈü≥È¢ë] ÂÆûÊó∂ÂØπËØùÂÆ¢Êà∑Á´ØÊú™Âä†ËΩΩÔºåÊó†Ê≥ïÊí≠ÊîæÊñáÊú¨:', src);
                if (options.onError) {
                    options.onError(new Error('ÂÆûÊó∂ÂØπËØùÂÆ¢Êà∑Á´ØÊú™Âä†ËΩΩ'));
                }
            }
        }

        // ‰ºòÂåñÁöÑ‰∏çÊ¥ªÂä®ÈÄªËæë
        function playRandomPrompt() {
            if (audioPlayer.paused && !state.isSpeaking) {
                if (state.inactivityLevel === 0) {
                    // Á¨¨‰∏ÄÊ¨°ÊèêÁ§∫Ôºö‰ΩøÁî®TTSÊí≠ÊîæÈöèÊú∫ÊèêÁ§∫ÊñáÊú¨
                    const randomIndex = Math.floor(Math.random() * PROMPT_TEXTS.length);
                    const promptText = PROMPT_TEXTS[randomIndex];
                    showPromptIndicator(promptText);
                    playAudio(promptText, () => {
                        state.inactivityLevel = 1;
                        resetInactivityTimer();
                    });
                } else if (state.inactivityLevel === 1) {
                    // Á¨¨‰∫åÊ¨°ÊèêÁ§∫Ôºö‰ΩøÁî®TTSÊí≠ÊîæÊúÄÁªàÊèêÁ§∫ÊñáÊú¨
                    showPromptIndicator(FINAL_PROMPT_TEXT);
                    playAudio(FINAL_PROMPT_TEXT, () => {
                        state.inactivityLevel = 0;
                        resetInactivityTimer();
                    });
                }
            } else {
                resetInactivityTimer();
            }
        }

        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            state.inactivityLevel = 0;

            // Á¨¨‰∏ÄÊ¨°ÊèêÁ§∫Ôºö4Áßí
            inactivityTimer = setTimeout(() => {
                if (!state.isSpeaking && audioPlayer.paused) {
                    playRandomPrompt();
                }
            }, INACTIVITY_THRESHOLD_1);

            // Á¨¨‰∫åÊ¨°ÊèêÁ§∫Ôºö8ÁßíÔºàÂú®Á¨¨‰∏ÄÊ¨°Âü∫Á°Ä‰∏äÂÜç4ÁßíÔºâ
            setTimeout(() => {
                if (state.inactivityLevel === 1 && !state.isSpeaking && audioPlayer.paused) {
                    playRandomPrompt();
                }
            }, INACTIVITY_THRESHOLD_2);
        }

        function showPromptIndicator(message) {
            const existing = document.querySelector('.prompt-indicator');
            if (existing) existing.remove();

            const indicator = document.createElement('div');
            indicator.className = 'prompt-indicator';
            indicator.textContent = message;
            document.body.appendChild(indicator);
            setTimeout(() => indicator.remove(), 3000);
        }

        // ‰∫ã‰ª∂ÁõëÂê¨Âô®
        // Ê†áËÆ∞‰∫ã‰ª∂ÁõëÂê¨Âô®ÊòØÂê¶Â∑≤ÁªëÂÆö
        let eventListenersSetup = false;
        
        function setupEventListeners() {
            // Èò≤Ê≠¢ÈáçÂ§çÁªëÂÆö‰∫ã‰ª∂ÁõëÂê¨Âô®
            if (eventListenersSetup) {
                return;
            }
            eventListenersSetup = true;
            
            startTestBtn.addEventListener('click', startTest);
            prevBtn.addEventListener('click', () => navigate(-1));
            nextBtn.addEventListener('click', () => navigate(1));
            finishBtn.addEventListener('click', finishAndSave);

            document.getElementById('zoom-in-btn').addEventListener('click', () => {
                updateTransform({ zoom: state.zoom * 1.2 });
                resetInactivityTimer();
            });
            document.getElementById('zoom-out-btn').addEventListener('click', () => {
                updateTransform({ zoom: Math.max(0.2, state.zoom / 1.2) });
                resetInactivityTimer();
            });
            document.getElementById('rotate-left-btn').addEventListener('click', () => {
                updateTransform({ rotation: state.rotation - 30 });
                resetInactivityTimer();
            });
            document.getElementById('rotate-right-btn').addEventListener('click', () => {
                updateTransform({ rotation: state.rotation + 30 });
                resetInactivityTimer();
            });
            document.getElementById('pen-tool').addEventListener('click', () => {
                selectTool('pen');
                resetInactivityTimer();
            });
            document.getElementById('eraser-tool').addEventListener('click', () => {
                selectTool('eraser');
                resetInactivityTimer();
            });
            document.querySelectorAll('.color-option').forEach(opt => {
                opt.addEventListener('click', (e) => {
                    selectColor(e.target.dataset.color);
                    resetInactivityTimer();
                });
            });

            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
        }

        /**
         * Á¶ÅÁî®"‰∏ã‰∏ÄÂº†"ÊåâÈíÆÂπ∂ÂºÄÂßãÂÜ∑Âç¥ÂÄíËÆ°Êó∂
         */
        function disableNextButton() {
            // Â¶ÇÊûúÂ∑≤ÁªèÂú®ÂÜ∑Âç¥‰∏≠ÔºåÁõ¥Êé•ËøîÂõû
            if (state.nextButtonCooldown > 0) {
                return;
            }

            // Á¶ÅÁî®ÊåâÈíÆ
            nextBtn.disabled = true;
            state.nextButtonCooldown = NEXT_BUTTON_COOLDOWN;

            // Êõ¥Êñ∞ÊåâÈíÆÊñáÊú¨ÊòæÁ§∫ÂÄíËÆ°Êó∂
            function updateCooldownDisplay() {
                if (state.nextButtonCooldown > 0) {
                    nextBtn.textContent = `‰∏ã‰∏ÄÂº† ‚ñ∂ (${state.nextButtonCooldown}Áßí)`;
                    state.nextButtonCooldown--;
                } else {
                    // ÂÜ∑Âç¥ÁªìÊùüÔºåÊÅ¢Â§çÊåâÈíÆ
                    nextBtn.disabled = false;
                    nextBtn.textContent = '‰∏ã‰∏ÄÂº† ‚ñ∂';
                    if (nextButtonCooldownTimer) {
                        clearInterval(nextButtonCooldownTimer);
                        nextButtonCooldownTimer = null;
                    }
                }
            }

            // Á´ãÂç≥Êõ¥Êñ∞‰∏ÄÊ¨°ÊòæÁ§∫
            updateCooldownDisplay();

            // ÊØèÁßíÊõ¥Êñ∞‰∏ÄÊ¨°ÂÄíËÆ°Êó∂
            nextButtonCooldownTimer = setInterval(updateCooldownDisplay, 1000);
        }

        // ÂØºËà™ÂíåÁä∂ÊÄÅ
        function navigate(direction) {
            console.log('[Ë∞ÉËØï] navigate Ë¢´Ë∞ÉÁî®:', {
                direction,
                currentIndex: state.currentIndex,
                newIndex: state.currentIndex + direction
            });
            
            saveCanvasState(state.currentIndex);
            const newIndex = state.currentIndex + direction;
            
            // Â¶ÇÊûúÊòØÁÇπÂáª‰∏ã‰∏ÄÂº†ÔºåÊ£ÄÊü•ÊòØÂê¶Âú®ÂÜ∑Âç¥‰∏≠
            // ‰ΩÜÂ¶ÇÊûúÊòØÊúÄÂêé‰∏ÄÂº†ÂõæÔºàÂç≥Â∞ÜËøõÂÖ•ÈÄâÊã©Èò∂ÊÆµÔºâÔºåÂÖÅËÆ∏Êìç‰Ωú
            if (direction === 1 && state.nextButtonCooldown > 0) {
                // Â¶ÇÊûúÂç≥Â∞ÜËøõÂÖ•ÈÄâÊã©Èò∂ÊÆµÔºåÂÖÅËÆ∏Êìç‰ΩúÂπ∂Ê∏ÖÈô§ÂÜ∑Âç¥
                if (newIndex === state.totalImages) {
                    // Ê∏ÖÈô§ÂÜ∑Âç¥ÂÆöÊó∂Âô®
                    if (nextButtonCooldownTimer) {
                        clearInterval(nextButtonCooldownTimer);
                        nextButtonCooldownTimer = null;
                    }
                    state.nextButtonCooldown = 0;
                } else {
                    // Âú®ÂÜ∑Âç¥‰∏≠‰∏î‰∏çÊòØÊúÄÂêé‰∏ÄÂº†Ôºå‰∏çÂÖÅËÆ∏Êìç‰Ωú
                    return;
                }
            }

            if (direction === 1 && newIndex === state.totalImages) {
                // ËÆ∞ÂΩïÊúÄÂêé‰∏ÄÂº†ÂõæÁöÑÂØºËà™Êìç‰ΩúÔºàËøõÂÖ•ÈÄâÊã©Èò∂ÊÆµÔºâ
                if (window.InteractionTracker && window.InteractionTracker._trackNavigation) {
                    window.InteractionTracker._trackNavigation('next');
                }
                
                // ÊâìÂç∞ÊúÄÂêé‰∏ÄÂº†ÂõæÁöÑÊï∞ÊçÆÔºàÁ¶ªÂºÄÂâçÁöÑÂõæÁâàÊï∞ÊçÆÔºâ
                if (window.InteractionTracker && window.InteractionTracker.printDataStructures) {
                    window.InteractionTracker.printDataStructures(state.currentIndex);
                }
                
                // Ê∏ÖÈô§ÂÜ∑Âç¥ÂÆöÊó∂Âô®ÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
                if (nextButtonCooldownTimer) {
                    clearInterval(nextButtonCooldownTimer);
                    nextButtonCooldownTimer = null;
                }
                state.nextButtonCooldown = 0;
                nextBtn.disabled = false;
                nextBtn.textContent = '‰∏ã‰∏ÄÂº† ‚ñ∂';
                showPostTestView();
                return;
            }

            if (newIndex >= 0 && newIndex < state.totalImages) {
                // ËÆ∞ÂΩïÂØºËà™Êìç‰ΩúÔºàÂú®ÂàáÊç¢‰πãÂâçÔºåËÆ∞ÂΩïÁöÑÊòØÂΩìÂâçÂõæÁâàÁöÑÂØºËà™Êìç‰ΩúÔºâ
                if (window.InteractionTracker && window.InteractionTracker._trackNavigation) {
                    window.InteractionTracker._trackNavigation(direction === 1 ? 'next' : 'prev');
                }
                
                // ‰øùÂ≠òÁ¶ªÂºÄÂâçÁöÑÂõæÁâàÁ¥¢ÂºïÔºàÁî®‰∫éÊâìÂç∞Êó•ÂøóÔºâ
                const previousIndex = state.currentIndex;
                
                state.currentIndex = newIndex;
                console.log('[Ë∞ÉËØï] state.currentIndex Êõ¥Êñ∞‰∏∫:', state.currentIndex);
                
                // Êõ¥Êñ∞ËøΩË∏™Âô®ÁöÑÂΩìÂâçÂõæÁâàÁ¥¢ÂºïÔºàËÆ∞ÂΩïÊó∂Èó¥Êà≥Ôºâ
                // Ê≥®ÊÑèÔºöËøôÈáåËÆ∞ÂΩïÁöÑÊòØÂàáÊç¢Âà∞Êñ∞ÂõæÁâàÁöÑÊó∂Èó¥ÔºåÂç≥Êñ∞ÂõæÁâàÂºÄÂßãÁöÑÊó∂Èó¥
                if (window.InteractionTracker && window.InteractionTracker._updateCurrentPlate) {
                    window.InteractionTracker._updateCurrentPlate(state.currentIndex);
                }
                loadImage(state.currentIndex);
                updateProgress();
                
                console.log('[Ë∞ÉËØï] updateProgress ÂêéÔºåcurrentIndex:', state.currentIndex);
                
                // Â¶ÇÊûúÊòØÁÇπÂáª‰∏ã‰∏ÄÂº†ÔºàÂåÖÊã¨‰ªéÁ¨¨‰∏ÄÂº†ÂàáÊç¢Âà∞Á¨¨‰∫åÂº†ÔºâÔºåÂàáÊç¢Âà∞Êñ∞ÂõæÁâàÂêéÁ´ãÂç≥ÂêØÂä®ÂÜ∑Âç¥
                if (direction === 1) {
                    disableNextButton();
                    if (window.InteractionTracker && window.InteractionTracker.printDataStructures) {
                        window.InteractionTracker.printDataStructures(previousIndex);
                    }
                }
            }
            resetInactivityTimer();
        }

        function loadImage(index) {
            // Ê≥®ÊÑèÔºöÊó∂Èó¥Êà≥Â∑≤Âú® navigate() Êàñ startTest() ‰∏≠ËÆ∞ÂΩï
            // ËøôÈáå‰∏çÈúÄË¶ÅÂÜçÊ¨°ËÆ∞ÂΩïÔºåÂè™ÈúÄË¶ÅÁ°Æ‰øùÂõæÁâàÁ¥¢ÂºïÂêåÊ≠•
            if (window.InteractionTracker && window.InteractionTracker._updateCurrentPlate) {
                // Âè™Êõ¥Êñ∞Á¥¢ÂºïÔºå‰∏çËÆ∞ÂΩïÊó∂Èó¥Êà≥ÔºàÂõ†‰∏∫Â∑≤ÁªèËÆ∞ÂΩïËøá‰∫ÜÔºâ
                window.InteractionTracker._updateCurrentPlate(index);
            }
            updateTransform({ zoom: 1, rotation: 0 }, true);
            
            // ÂàáÊç¢ÂõæÁâàÊó∂Á´ãÂç≥Ê∏ÖÈô§ÁîªÂ∏ÉÔºàÈÅøÂÖçÊòæÁ§∫‰∏ä‰∏ÄÂº†ÂõæÁöÑËΩ®ËøπÔºâ
            clearCanvas();
            
            // ÁßªÈô§‰πãÂâçÁöÑ onload ‰∫ã‰ª∂Â§ÑÁêÜÂô®ÔºåÈÅøÂÖçÂÜ≤Á™Å
            rorschachImage.onload = null;
            
            rorschachImage.src = `./images/rorschach-blot-${index + 1}.png`;
            
            // Á°Æ‰øùÂõæÁâáÂä†ËΩΩÂêéÂä†ËΩΩËØ•ÂõæÁâàÁöÑÁîªÂ∏ÉÁä∂ÊÄÅ
            if (rorschachImage.complete) {
                // ÂõæÁâáÂ∑≤ÁºìÂ≠òÔºåÁ´ãÂç≥Âä†ËΩΩÁîªÂ∏ÉÁä∂ÊÄÅ
                resizeCanvas();
                loadCanvasState(index);
            } else {
                // ÂõæÁâáÈúÄË¶ÅÂä†ËΩΩÔºåÁ≠âÂæÖÂä†ËΩΩÂÆåÊàê
                rorschachImage.onload = () => {
                    resizeCanvas();
                    loadCanvasState(index);
                };
            }
            
            updateNavButtons();
        }

        function updateNavButtons() {
            prevBtn.disabled = state.currentIndex === 0;
            // "‰∏ã‰∏ÄÂº†"ÊåâÈíÆÁöÑÁ¶ÅÁî®Áä∂ÊÄÅÁî±ÂÜ∑Âç¥Êó∂Èó¥ÊéßÂà∂
            // Â¶ÇÊûúÊòØÊúÄÂêé‰∏ÄÂº†ÂõæÔºåÂßãÁªàÂÖÅËÆ∏ÁÇπÂáªÔºàËøõÂÖ•ÈÄâÊã©Èò∂ÊÆµ‰∏çÂèóÂÜ∑Âç¥ÈôêÂà∂Ôºâ
            if (state.currentIndex === state.totalImages - 1) {
                nextBtn.disabled = false;
                nextBtn.textContent = '‰∏ã‰∏ÄÂº† ‚ñ∂';
            }
            // ÂÖ∂‰ªñÊÉÖÂÜµ‰∏ãÔºåÁ¶ÅÁî®Áä∂ÊÄÅÁî±ÂÜ∑Âç¥ÂÆöÊó∂Âô®ÊéßÂà∂
        }

        function updateProgress() {
            console.log('[Ë∞ÉËØï] updateProgress Ë¢´Ë∞ÉÁî®ÔºåcurrentIndex:', state.currentIndex, 'ÊòæÁ§∫:', state.currentIndex + 1);
            progressText.textContent = `Á¨¨ ${state.currentIndex + 1} / ${state.totalImages} Âº†ÂõæÁâá`;
        }

        // ÂêéÊµãËØïËßÜÂõæ
        function showPostTestView() {
            clearTimeout(inactivityTimer);
            mainContent.style.display = 'none';
            controlsBar.style.display = 'none';
            postTestView.style.display = 'block';
            progressText.textContent = 'ÊµãËØïÊÄªÁªìÈò∂ÊÆµ';

            // ËÆ∞ÂΩïËøõÂÖ•ÈÄâÊã©Èò∂ÊÆµÁöÑÊó∂Èó¥
            if (window.InteractionTracker && window.InteractionTracker.recordSelectPhase) {
                window.InteractionTracker.recordSelectPhase();
            }

            const grid = document.getElementById('post-test-grid');
            grid.innerHTML = '';
            for (let i = 0; i < state.totalImages; i++) {
                const item = document.createElement('div');
                item.className = 'grid-item';
                item.dataset.index = i;
                item.innerHTML = `<img src="./images/rorschach-blot-${i + 1}.png" alt="Image ${i + 1}"><h4>Âõæ ${i + 1}</h4>`;
                item.addEventListener('click', handleImageSelection);
                grid.appendChild(item);
            }
            askNextQuestion();
        }

        function askNextQuestion() {
            document.querySelectorAll('.grid-item.selected').forEach(el => el.classList.remove('selected'));

            if (currentQuestionIndex >= POST_TEST_QUESTIONS.length) {
                questionText.textContent = "ÊâÄÊúâÈóÆÈ¢òÂ∑≤ÂõûÁ≠îÂÆåÊØï„ÄÇÊÑüË∞¢ÊÇ®ÁöÑÂèÇ‰∏éÔºÅ";
                document.getElementById('post-test-grid').style.display = 'none';
                finishBtn.style.display = 'inline-block';
                return;
            }

            const question = POST_TEST_QUESTIONS[currentQuestionIndex];
            questionText.textContent = question.text;
            const gridContainer = document.getElementById('post-test-grid');

            gridContainer.style.pointerEvents = 'none';
            // ‰ΩøÁî®TTSÊí≠ÊîæÈóÆÈ¢òÊñáÊú¨Ôºà‰ΩøÁî®question.textËÄå‰∏çÊòØquestion.audioÔºâ
            playAudio(question.text, () => {
                if (question.key !== 'mood') {
                    gridContainer.style.pointerEvents = 'auto';
                } else {
                    currentQuestionIndex++;
                    setTimeout(askNextQuestion, 1500);
                }
            });
        }

        function handleImageSelection(event) {
            const selectedIndex = event.currentTarget.dataset.index;
            const questionKey = POST_TEST_QUESTIONS[currentQuestionIndex].key;
            state.postTestAnswers[questionKey] = parseInt(selectedIndex) + 1;

            document.querySelectorAll('.grid-item.selected').forEach(el => el.classList.remove('selected'));
            event.currentTarget.classList.add('selected');

            currentQuestionIndex++;

            document.getElementById('post-test-grid').style.pointerEvents = 'none';
            setTimeout(askNextQuestion, 500);
        }

        // ÂÆåÊàêÂíåÊ±áÊÄª
        function finishAndSave() {
            if (state.mediaRecorder && state.mediaRecorder.state === 'recording') {
                state.mediaRecorder.stop();
            }
            
            // ÂØºÂá∫‰∫§‰∫íËøΩË∏™Êï∞ÊçÆ
            if (window.InteractionTracker) {
                try {
                    window.InteractionTracker.stop();
                    
                    // ËæìÂá∫ÊâÄÊúâÁâàÂõæÁöÑÁªüËÆ°‰ø°ÊÅØÔºàÂÆåÊï¥Êï∞ÊçÆÔºâ
                    window.InteractionTracker.printAllPlatesStatistics();
                    
                    const interactionData = window.InteractionTracker.exportJSON({
                        pretty: true,
                        includeStats: true,
                        includeMetadata: true
                    });
                    console.log('[‰∫§‰∫íËøΩË∏™Êï∞ÊçÆ]', JSON.parse(interactionData));
                    
                    // Ëé∑ÂèñÊóãËΩ¨Ê¨°Êï∞ÁªüËÆ°Êï∞ÊçÆÔºà‰ªÖËÆ∞ÂΩïÂà∞ÊéßÂà∂Âè∞Ôºå‰∏çËá™Âä®ÂØºÂá∫Ôºâ
                    const rotationCounts = window.InteractionTracker.getRotationCounts();
                    console.log('[ÊóãËΩ¨Ê¨°Êï∞ÁªüËÆ°]', rotationCounts);
                    
                    // Ëé∑ÂèñÁîªÁ¨îËΩ®ËøπÊï∞ÊçÆÔºà‰ªÖËÆ∞ÂΩïÂà∞ÊéßÂà∂Âè∞Ôºå‰∏çËá™Âä®ÂØºÂá∫Ôºâ
                    const drawingTracks = window.InteractionTracker.getDrawingTracks();
                    console.log('[ÁîªÁ¨îËΩ®ËøπÊï∞ÊçÆ]', drawingTracks);
                    
                    // Ëé∑ÂèñÈü≥È¢ëÊó∂Èó¥Êà≥ÁªüËÆ°Êï∞ÊçÆÔºà‰ªÖËÆ∞ÂΩïÂà∞ÊéßÂà∂Âè∞Ôºå‰∏çËá™Âä®ÂØºÂá∫Ôºâ
                    const audioTimestamps = window.InteractionTracker.getAudioTimestamps();
                    console.log('[Èü≥È¢ëÊó∂Èó¥Êà≥ÁªüËÆ°ÔºàÁõ∏ÂØπÊó∂Èó¥Ôºâ]', audioTimestamps);
                    
                    // Ëé∑ÂèñÁªùÂØπÊó∂Èó¥Êà≥ÁªüËÆ°Êï∞ÊçÆ
                    const absoluteTimestamps = window.InteractionTracker.getAbsoluteTimestamps();
                    console.log('[ÁªùÂØπÊó∂Èó¥Êà≥ÁªüËÆ°]', absoluteTimestamps);
                    
                    // ÂèØÈÄâÔºöËá™Âä®‰∏ãËΩΩÂÆåÊï¥‰∫§‰∫íÊï∞ÊçÆ
                    // window.InteractionTracker.download('json');
                } catch (error) {
                    console.error('[‰∫§‰∫íËøΩË∏™] ÂØºÂá∫Êï∞ÊçÆÂ§±Ë¥•:', error);
                }
            }
            
            // Ë∞ÉÁî®Êé•Âè£Êèê‰∫§Êï∞ÊçÆÂà∞ÊúçÂä°Âô®
            if (window.submitTestDataToServer && window.InteractionTracker) {
                // ‰ΩøÁî®ÂºÇÊ≠•ÊñπÂºèÊèê‰∫§Ôºå‰∏çÈòªÂ°ûÈ°µÈù¢ÊòæÁ§∫
                (async () => {
                    try {
                        // ÊòæÁ§∫Êèê‰∫§ÊèêÁ§∫
                        if (finishBtn) {
                            finishBtn.disabled = true;
                            finishBtn.textContent = 'Ê≠£Âú®Êèê‰∫§Êï∞ÊçÆ...';
                        }
                        
                        // Ëé∑ÂèñÈü≥È¢ëÊï∞ÊçÆÔºà‰ªéstate.audioBlobÊàñÈáçÊñ∞ÂàõÂª∫Ôºâ
                        let audioBlob = state.audioBlob;
                        if (!audioBlob && state.audioChunks && state.audioChunks.length > 0) {
                            audioBlob = new Blob(state.audioChunks, { type: 'audio/webm' });
                        }
                        
                        // Ë∞ÉÁî®Êé•Âè£Êèê‰∫§Êï∞ÊçÆ
                        const result = await window.submitTestDataToServer(
                            window.InteractionTracker,
                            audioBlob,
                            state.postTestAnswers
                        );
                        
                        console.log('[API] Êï∞ÊçÆÊèê‰∫§ÊàêÂäü:', result);
                        
                        // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
                        if (finishBtn) {
                            finishBtn.textContent = '‚úÖ Êï∞ÊçÆÂ∑≤Êèê‰∫§ÊàêÂäü';
                            finishBtn.style.backgroundColor = '#10b981';
                        }
                    } catch (error) {
                        console.error('[API] Êèê‰∫§Êï∞ÊçÆÂ§±Ë¥•:', error);
                        
                        // ÊòæÁ§∫ÈîôËØØÊèêÁ§∫Ôºà‰∏çÂΩ±ÂìçÁªßÁª≠ÊòæÁ§∫Ê±áÊÄªÈ°µÈù¢Ôºâ
                        if (finishBtn) {
                            finishBtn.textContent = '‚ö†Ô∏è Êï∞ÊçÆÊèê‰∫§Â§±Ë¥•ÔºàÂ∑≤‰øùÂ≠òÊú¨Âú∞Ôºâ';
                            finishBtn.style.backgroundColor = '#f59e0b';
                        }
                    }
                })();
            }
            
            showSummary();
        }

        function showSummary() {
            postTestView.style.display = 'none';
            summaryView.style.display = 'block';
            progressText.textContent = 'ÊµãËØïÂ∑≤ÂÆåÊàêÔºÅ';

            const grid = document.getElementById('summary-grid');
            grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px; background: var(--primary-lighter); border-radius: 12px; margin-bottom: 20px;"><h3 style="color: var(--primary-color); margin: 0;">‚úÖ ÊÑüË∞¢ÊÇ®ÁöÑÂèÇ‰∏éÔºÅÊÇ®ÁöÑÂΩïÈü≥Êñá‰ª∂Â∑≤ÂºÄÂßã‰∏ãËΩΩ„ÄÇ</h3></div>';

            for (let i = 0; i < state.totalImages; i++) {
                const item = document.createElement('div');
                item.className = 'summary-item';
                item.innerHTML = `<h4>Âõæ ${i + 1}</h4>`;
                const compositeContainer = document.createElement('div');
                compositeContainer.style.position = 'relative';
                const baseImage = document.createElement('img');
                baseImage.src = `./images/rorschach-blot-${i + 1}.png`;
                compositeContainer.appendChild(baseImage);
                if (state.canvasStates[i]) {
                    const drawingImage = document.createElement('img');
                    drawingImage.src = state.canvasStates[i];
                    drawingImage.style.position = 'absolute';
                    drawingImage.style.top = 0;
                    drawingImage.style.left = 0;
                    drawingImage.style.width = '100%';
                    drawingImage.style.height = '100%';
                    compositeContainer.appendChild(drawingImage);
                }
                item.appendChild(compositeContainer);
                grid.appendChild(item);
            }
        }

        // ÁªòÂõæÂíåÂèòÊç¢
        function updateTransform(newTransforms = {}, force = false) {
            if (!force) {
                state.zoom = newTransforms.zoom !== undefined ? Math.max(0.2, newTransforms.zoom) : state.zoom;
                state.rotation = newTransforms.rotation !== undefined ? newTransforms.rotation : state.rotation;
            } else {
                state.zoom = newTransforms.zoom;
                state.rotation = newTransforms.rotation;
            }
            imageContainer.style.transform = `scale(${state.zoom}) rotate(${state.rotation}deg)`;
        }

        let lastX = 0, lastY = 0;

        function startDrawing(e) {
            state.drawing = true;
            const rect = canvas.getBoundingClientRect();
            lastX = e.clientX - rect.left;
            lastY = e.clientY - rect.top;
            
            // ËøΩË∏™ÁîªÁ¨îËΩ®ËøπÂºÄÂßãÔºà‰ªÖËÆ∞ÂΩïÁîªÁ¨îÔºå‰∏çËÆ∞ÂΩïÊ©°ÁöÆÊì¶Ôºâ
            if (state.tool === 'pen' && window.InteractionTracker && window.InteractionTracker._trackDrawingStart) {
                window.InteractionTracker._trackDrawingStart(lastX, lastY);
            }
            
            resetInactivityTimer();
        }

        function draw(e) {
            if (!state.drawing) return;
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            ctx.beginPath();
            if (state.tool === 'pen') {
                ctx.globalCompositeOperation = 'source-over';
                ctx.strokeStyle = state.color;
                ctx.lineWidth = 5;
            } else if (state.tool === 'eraser') {
                ctx.globalCompositeOperation = 'destination-out';
                ctx.lineWidth = 20;
            }
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.stroke();
            
            // ËøΩË∏™ÁîªÁ¨îËΩ®ËøπÁÇπÔºà‰ªÖËÆ∞ÂΩïÁîªÁ¨îÔºå‰∏çËÆ∞ÂΩïÊ©°ÁöÆÊì¶Ôºâ
            if (state.tool === 'pen' && window.InteractionTracker && window.InteractionTracker._trackDrawingPoint) {
                window.InteractionTracker._trackDrawingPoint(x, y);
            }
            
            lastX = x;
            lastY = y;
            resetInactivityTimer();
        }

        function stopDrawing() {
            state.drawing = false;
            
            // ËøΩË∏™ÁîªÁ¨îËΩ®ËøπÁªìÊùüÔºà‰ªÖÁîªÁ¨îÊ®°ÂºèÊâçËÆ∞ÂΩïÔºâ
            if (state.tool === 'pen' && window.InteractionTracker && window.InteractionTracker._trackDrawingEnd) {
                window.InteractionTracker._trackDrawingEnd();
            }
        }

        function selectTool(tool) {
            state.tool = tool;
            document.getElementById('pen-tool').classList.toggle('selected', tool === 'pen');
            document.getElementById('eraser-tool').classList.toggle('selected', tool === 'eraser');
        }

        function selectColor(color) {
            state.color = color;
            document.querySelectorAll('.color-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.color === color);
            });
            selectTool('pen');
        }

        function saveCanvasState(index) {
            if (canvas.width > 0 && canvas.height > 0) {
                state.canvasStates[index] = canvas.toDataURL();
            }
        }

        function loadCanvasState(index) {
            clearCanvas();
            const dataUrl = state.canvasStates[index];
            if (dataUrl) {
                const img = new Image();
                img.src = dataUrl;
                img.onload = () => ctx.drawImage(img, 0, 0);
            }
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            // È°µÈù¢Âä†ËΩΩÂêéÔºöËÆæÁΩÆ‰ªãÁªçÊñáÊ°àÂπ∂Â∞ùËØïËá™Âä®Êí≠Êä•‰∏ÄÊ¨°
            const introTextEl = document.getElementById('intro-text');
            if (introTextEl) {
                introTextEl.textContent = INTRO_TEXT;
            }
        });
    </script>
</body>
</html>