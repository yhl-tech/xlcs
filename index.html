<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç½—å¤å¢¨è¿¹æµ‹è¯•-å›¾ç‰ˆ</title>
    <style>
        :root {
            --primary-color: #1e3a8a;
            --primary-light: #3b82f6;
            --primary-lighter: #dbeafe;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --border-color: #e2e8f0;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 20px 25px rgba(0, 0, 0, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: var(--bg-gradient);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            user-select: none;
            overflow: hidden;
        }

        /* å±å¹•åˆ‡æ¢ */
        .screen {
            display: none;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
        }

        #info-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            background: var(--bg-gradient);
        }

        .info-card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 50px 40px;
            box-shadow: var(--shadow-lg);
            max-width: 450px;
            width: 100%;
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .info-card h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
            font-weight: 700;
        }

        .info-form-group {
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
        }

        .info-form-group label {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
        }

        .info-form-group input {
            padding: 12px 14px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #f9fafb;
        }

        .info-form-group input:focus {
            outline: none;
            border-color: var(--primary-light);
            background: white;
            box-shadow: 0 0 0 3px var(--primary-lighter);
        }

        #start-test-btn {
            width: 100%;
            padding: 14px;
            margin-top: 30px;
            background: var(--primary-light);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
        }

        #start-test-btn:hover {
            background: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        #start-test-btn:active {
            transform: translateY(0);
        }

        #enter-btn {
            padding: 8px 28px;
            margin-top: 10px;
            background: var(--primary-light);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }
        /* åº”ç”¨çª—å£ */
        .app-window {
            display: flex;
            flex-direction: column;
            width: 95vw;
            max-width: 1200px;
            height: 95vh;
            max-height: 900px;
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }

        .title-bar {
            background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
            color: white;
            padding: 16px 24px;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }

        .progress-info {
            font-size: 14px;
            opacity: 0.9;
        }

        .main-content {
            flex: 1;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background: #fafafa;
        }

        #intro-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.95) 100%);
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 30px;
            box-sizing: border-box;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        #intro-image {
            max-width: 300px;
            max-height: 300px;
            object-fit: contain;
            margin-bottom: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
        }

        #intro-text {
            font-size: 15px;
            line-height: 1.8;
            max-width: 700px;
            text-align: left;
            color: var(--text-primary);
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            max-height: 40vh;
            overflow-y: auto;
        }

        #image-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }

        #rorschach-image {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 8px;
            transition: transform 0.2s ease-out;
        }

        #drawing-canvas {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            cursor: crosshair;
            max-width: 90%;
            max-height: 90%;
        }

        /* åæµ‹è¯•è§†å›¾ */
        #post-test-view,
        #summary-view {
            padding: 30px;
            overflow-y: auto;
            height: 100%;
            background: var(--card-bg);
            box-sizing: border-box;
        }

        #post-test-view h2,
        #summary-view h2 {
            text-align: center;
            margin-bottom: 25px;
            color: var(--primary-color);
            font-size: 24px;
            font-weight: 700;
        }

        #question-text {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            text-align: center;
            min-height: 40px;
            margin-bottom: 30px;
            padding: 15px;
            background: var(--primary-lighter);
            border-radius: 10px;
            animation: slideUp 0.3s ease-out;
        }

        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .grid-item {
            border: 3px solid var(--border-color);
            border-radius: 12px;
            padding: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            overflow: hidden;
        }

        .grid-item:hover {
            border-color: var(--primary-light);
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }

        .grid-item.selected {
            border-color: var(--success-color);
            background: linear-gradient(135deg, rgba(16,185,129,0.1) 0%, rgba(16,185,129,0.05) 100%);
            box-shadow: 0 0 0 3px rgba(16,185,129,0.2);
            transform: scale(1.05);
        }

        .grid-item img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            display: block;
        }

        .grid-item h4 {
            margin-top: 8px;
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .summary-grid {
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        }

        .summary-item {
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            background: white;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
        }

        .summary-item:hover {
            box-shadow: var(--shadow-md);
        }

        .summary-item h4 {
            margin-bottom: 12px;
            color: var(--primary-color);
            font-weight: 600;
        }

        .summary-item img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        /* æ§åˆ¶æ  */
        .controls-bar {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 16px;
            border-top: 2px solid var(--border-color);
            background: linear-gradient(90deg, #f8fafc 0%, #f0f9ff 100%);
            flex-wrap: wrap;
            gap: 12px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            padding: 8px 12px;
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
        }

        .control-group button {
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s ease;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .control-group button:hover {
            border-color: var(--primary-light);
            background: var(--primary-lighter);
            color: var(--primary-color);
        }

        .control-group button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .control-group button.selected {
            background: var(--primary-light);
            border-color: var(--primary-color);
            color: white;
            box-shadow: 0 0 0 3px var(--primary-lighter);
        }

        .color-selector {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .color-option {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
        }

        .color-option:hover {
            transform: scale(1.15);
        }

        .color-option.selected {
            border-color: #333;
            box-shadow: 0 0 0 2px white, 0 0 0 4px #333;
        }

        #finish-btn {
            padding: 12px 28px;
            margin-top: 25px;
            background: var(--success-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-md);
        }

        #finish-btn:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        /* æç¤ºæŒ‡ç¤ºå™¨ */
        .prompt-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--warning-color);
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            animation: slideInUp 0.3s ease-out;
            box-shadow: var(--shadow-lg);
            z-index: 200;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .info-card {
                padding: 30px 20px;
            }

            .image-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 10px;
            }

            .summary-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }

            .controls-bar {
                gap: 8px;
            }

            .control-group {
                padding: 6px 8px;
                font-size: 12px;
            }

            .control-group button {
                padding: 6px 10px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>

    <!-- ä¿¡æ¯è¾“å…¥å±å¹• -->
    <div id="info-screen" class="screen">
        <div class="info-card">
            <h1>ğŸ¨ ç½—å¤å¢¨è¿¹æµ‹è¯•</h1>
            <div class="info-form-group">
                <label for="age">å¹´é¾„</label>
                <input type="text" id="age" placeholder="ä¾‹å¦‚ï¼š25">
            </div>
            <div class="info-form-group">
                <label for="education">å­¦å†</label>
                <input type="text" id="education" placeholder="ä¾‹å¦‚ï¼šæœ¬ç§‘">
            </div>
            <div class="info-form-group">
                <label for="occupation">èŒä¸š</label>
                <input type="text" id="occupation" placeholder="ä¾‹å¦‚ï¼šå·¥ç¨‹å¸ˆ">
            </div>
            <div class="info-form-group">
                <label for="mood">å½“å‰å¿ƒæƒ…</label>
                <input type="text" id="mood" placeholder="ä¾‹å¦‚ï¼šå¹³é™">
            </div>
            <button id="start-test-btn">å¼€å§‹æµ‹è¯•</button>
        </div>
    </div>

    <!-- ä¸»åº”ç”¨çª—å£ -->
    <div id="app-window" class="app-window screen">
        <div class="title-bar">
            <span>ğŸ¨ ç½—å¤å¢¨è¿¹æµ‹è¯•</span>
            <span class="progress-info" id="progress-text">å‡†å¤‡ä¸­...</span>
        </div>

        <div class="main-content" id="main-content">
            <div id="intro-overlay">
                <img id="intro-image" src="./images/rorschach-blot-example.png" alt="ä»‹ç»">
                <p id="intro-text"></p>
                <button id="enter-btn" style="display: none;">è¿›å…¥</button>
            </div>
            <div id="image-container">
                <img id="rorschach-image" src="" alt="ç½—å¤å¢¨è¿¹å›¾">
                <canvas id="drawing-canvas"></canvas>
            </div>
        </div>

        <div id="post-test-view" style="display: none;">
            <h2>ğŸ“Š æµ‹è¯•æ€»ç»“ä¸åæ€</h2>
            <p id="question-text"></p>
            <div id="post-test-grid" class="image-grid"></div>
            <button id="finish-btn" style="display: none;">âœ… å®Œæˆæµ‹è¯•å¹¶æŸ¥çœ‹æ±‡æ€»</button>
        </div>

        <div id="summary-view" style="display: none;">
            <h2>ğŸ“ˆ å®Œæ•´æµ‹è¯•æ±‡æ€»</h2>
            <div id="summary-grid" class="image-grid"></div>
        </div>

        <div class="controls-bar" id="controls-bar" style="display: none;">
            <div class="control-group">
                <button id="prev-btn">â—€ ä¸Šä¸€å¼ </button>
            </div>
            <div class="control-group">
                <button id="zoom-in-btn">ğŸ”+ æ”¾å¤§</button>
                <button id="zoom-out-btn">ğŸ”- ç¼©å°</button>
                <button id="rotate-left-btn">â†¶ å·¦è½¬</button>
                <button id="rotate-right-btn">â†· å³è½¬</button>
            </div>
            <div class="control-group">
                <button id="pen-tool" class="selected">âœï¸ ç”»ç¬”</button>
                <div class="color-selector">
                    <div class="color-option selected" data-color="red" style="background-color: #ef4444;"></div>
                    <div class="color-option" data-color="green" style="background-color: #10b981;"></div>
                    <div class="color-option" data-color="blue" style="background-color: #3b82f6;"></div>
                </div>
                <button id="eraser-tool">ğŸ—‘ï¸ æ“¦é™¤</button>
            </div>
            <div class="control-group">
                <button id="next-btn">ä¸‹ä¸€å¼  â–¶</button>
            </div>
        </div>
    </div>

    <audio id="audio-player"></audio>

    <!-- Axios åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <!-- äº¤äº’è¿½è¸ªç³»ç»Ÿ -->
    <script type="module" src="./script/interactionTracker.js"></script>
    
    <!-- API æ¥å£æ¨¡å— -->
    <script type="module" src="./script/api.js"></script>
    
    <!-- TTS è¯­éŸ³åˆæˆå®¢æˆ·ç«¯ -->
    <script type="module" src="./script/ttsClient.js"></script>

    <script>
        const state = {
            currentIndex: 0,
            totalImages: 10,
            zoom: 1,
            rotation: 0,
            drawing: false,
            tool: 'pen',
            color: 'red',
            canvasStates: new Array(10).fill(null),
            isSpeaking: false,
            mediaRecorder: null,
            audioChunks: [],
            audioBlob: null,  // ä¿å­˜å®Œæ•´çš„éŸ³é¢‘Blobï¼Œä¾›æ¥å£æäº¤ä½¿ç”¨
            postTestAnswers: {},
            inactivityLevel: 0,
            nextButtonCooldown: 0  // "ä¸‹ä¸€å¼ "æŒ‰é’®å†·å´æ—¶é—´ï¼ˆç§’ï¼‰
        };
        
        // å°† state æŒ‚è½½åˆ° window å¯¹è±¡ï¼Œä»¥ä¾¿ InteractionTracker å¯ä»¥è®¿é—®
        window.state = state;

        let inactivityTimer = null;
        let nextButtonCooldownTimer = null;  // "ä¸‹ä¸€å¼ "æŒ‰é’®å†·å´å®šæ—¶å™¨
        const INACTIVITY_THRESHOLD_1 = 4000;  // ç¬¬ä¸€æ¬¡æç¤º
        const INACTIVITY_THRESHOLD_2 = 8000;  // ç¬¬äºŒæ¬¡æç¤º
        const NEXT_BUTTON_COOLDOWN = 30;  // "ä¸‹ä¸€å¼ "æŒ‰é’®å†·å´æ—¶é—´ï¼ˆç§’ï¼‰
        // æç¤ºæ–‡æœ¬æ•°ç»„ï¼ˆç”¨äºTTSè¯­éŸ³åˆæˆï¼‰
        const PROMPT_TEXTS = [
            'æç¤ºï¼šè¯·ç»§ç»­æè¿°...',
            'æ‚¨è¿˜èƒ½çœ‹åˆ°äº›ä»€ä¹ˆå—ï¼Ÿ',
            'è¯·è¯¦ç»†æè¿°ä¸€ä¸‹æ‚¨çœ‹åˆ°çš„å†…å®¹',
            'é™¤äº†è¿™ä¸ªï¼Œæ‚¨è¿˜èƒ½çœ‹åˆ°ä»€ä¹ˆï¼Ÿ',
            'è¯·ç»§ç»­åˆ†äº«æ‚¨çš„è§‚å¯Ÿ',
            'æ‚¨å¯ä»¥æ›´è¯¦ç»†åœ°æè¿°ä¸€ä¸‹å—ï¼Ÿ'
        ];
        const FINAL_PROMPT_TEXT = 'æç¤ºï¼šè¯·ç‚¹å‡»ä¸‹ä¸€å¼ å›¾ç‰‡ç»§ç»­...';
        
        const POST_TEST_QUESTIONS = [
            { key: 'represent', text: 'åå¼ å›¾ç‰‡é‡Œï¼Œé€‰æ‹©ä¸€å¼ æœ€èƒ½ä»£è¡¨ä½ çš„ã€‚', audio: './audio/q_represent.wav' },
            { key: 'mother', text: 'åå¼ å›¾ç‰‡é‡Œï¼Œé€‰æ‹©ä¸€å¼ æœ€èƒ½ä»£è¡¨ä½ æ¯äº²çš„ã€‚', audio: './audio/q_mother.wav' },
            { key: 'father', text: 'åå¼ å›¾ç‰‡é‡Œï¼Œé€‰æ‹©ä¸€å¼ æœ€èƒ½ä»£è¡¨ä½ çˆ¶äº²çš„ã€‚', audio: './audio/q_father.wav' },
            { key: 'like', text: 'åå¼ å›¾ç‰‡é‡Œï¼Œä½ æœ€å–œæ¬¢å“ªä¸€å¼ ï¼Ÿ', audio: './audio/q_like.wav' },
            { key: 'dislike', text: 'åå¼ å›¾ç‰‡é‡Œï¼Œä½ æœ€è®¨åŒå“ªä¸€å¼ ï¼Ÿ', audio: './audio/q_dislike.wav' },
            { key: 'mood', text: 'æµ‹è¯•åˆ°æ­¤ä¸ºæ­¢äº†ï¼Œä½ ç°åœ¨å¿ƒæƒ…å¦‚ä½•ï¼Ÿç›¸æ¯”åˆšå¼€å§‹æµ‹è¯•æ—¶ï¼Ÿ', audio: './audio/q_mood.wav' }
        ];
        
        let currentQuestionIndex = 0;

        // DOM Elements
        const infoScreen = document.getElementById('info-screen');
        const appWindow = document.getElementById('app-window');
        const mainContent = document.getElementById('main-content');
        const startTestBtn = document.getElementById('start-test-btn');
        const introOverlay = document.getElementById('intro-overlay');
        const introText = document.getElementById('intro-text');
        const enterBtn = document.getElementById('enter-btn');
        const audioPlayer = document.getElementById('audio-player');
        const controlsBar = document.getElementById('controls-bar');
        const rorschachImage = document.getElementById('rorschach-image');
        const canvas = document.getElementById('drawing-canvas');
        const imageContainer = document.getElementById('image-container');
        const postTestView = document.getElementById('post-test-view');
        const summaryView = document.getElementById('summary-view');
        const questionText = document.getElementById('question-text');
        const finishBtn = document.getElementById('finish-btn');
        const nextBtn = document.getElementById('next-btn');
        const prevBtn = document.getElementById('prev-btn');
        const progressText = document.getElementById('progress-text');
        const ctx = canvas.getContext('2d');

        // å¯åŠ¨æµ‹è¯•
        async function startTest() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                initAudio(stream);

                infoScreen.style.display = 'none';
                appWindow.style.display = 'flex';

                const introTextContent = `ç½—å¤å¢¨è¿¹æ˜¯ç‘å£«å¿ƒç†å­¦å®¶å‘æ˜çš„ä¸€ç§æŠ•å°„æ³•å¿ƒç†æµ‹è¯•æ–¹æ³•ã€‚æˆ‘ä¼šä¾æ¬¡ç»™ä½ å±•ç¤ºåå¼ å¢¨è¿¹çš„å›¾ç‰‡ï¼Œè¿™äº›å¢¨è¿¹ç‚¹çš„ç»˜åˆ¶éƒ½æ˜¯éšæœºçš„ï¼Œä¹Ÿæ˜¯æŠ½è±¡çš„ï¼Œæ¯ä¸ªäººçœ‹åˆ°çš„å†…å®¹éƒ½ä¸åŒã€‚

ä½ è¦åšçš„å°±æ˜¯å‘Šè¯‰æˆ‘ï¼Œä½ ä»å›¾ç‰‡ä¸­çœ‹åˆ°äº†ä»€ä¹ˆï¼Œå¹¶ä¸”æè¿°ä¸€ä¸‹ä½ æ‰€çœ‹åˆ°çš„ä¸œè¥¿ã€è”æƒ³åˆ°çš„ä¸œè¥¿ã€‚ä¸ç®¡çœ‹è§ä»€ä¹ˆï¼Œéƒ½å¯ä»¥è¡¨è¿°å›ç­”ï¼Œæ²¡æœ‰ä»€ä¹ˆæ­£ç¡®ã€é”™è¯¯çš„å›ç­”ã€‚

ä½ å¯ä»¥è§‚å¯Ÿä¸€ä¸‹è¿™ä¸ªè½¯ä»¶ç•Œé¢ä¸Šçš„å„ç§æŒ‰é’®ï¼Œåœ¨æµ‹è¯•çš„æ—¶å€™å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦è¿›è¡Œè°ƒæ•´è§‚å¯Ÿå›¾ç‰‡çš„è§†è§’ï¼Œæ¯”å¦‚æ”¾å¤§ã€ç¼©å°ã€æ—‹è½¬å›¾ç‰‡ï¼Œè¿˜å¯ä»¥åœ¨æè¿°çš„æ—¶å€™ä½¿ç”¨ç”»ç¬”æ¥å‹¾ç”»ç­‰ç­‰ã€‚

æ€»ä¹‹ï¼Œè§‚çœ‹ç†è§£å›¾ç‰‡ï¼Œä¸å—ä»»ä½•é™åˆ¶ã€‚æµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä¸ä¼šè¯¢é—®ä½ çš„éšç§ä¿¡æ¯ï¼Œæ‰€ä»¥å®‰å…¨æ€§ä½ å¯ä»¥æ”¾å¿ƒã€‚`;
                introText.textContent = introTextContent;
                // æ˜¾ç¤º"è¿›å…¥"æŒ‰é’®
                enterBtn.style.display = 'block';
                
                // ç‚¹å‡»"è¿›å…¥"æŒ‰é’®åè¿æ¥ WebSocket å¹¶å¼€å§‹å½•éŸ³ï¼Œç›´æ¥è¿›å…¥æµ‹è¯•æµç¨‹
                enterBtn.onclick = async () => {
                    try {
                        enterBtn.disabled = true;
                        enterBtn.textContent = 'è¿æ¥ä¸­...';
                        
                        // è¿æ¥è±†åŒ…å®æ—¶è¯­éŸ³ WebSocket
                        if (window.dialogClient) {
                            if (!window.dialogClient.isConnected) {
                                await window.dialogClient.connect();
                            }
                            // å¼€å§‹å½•éŸ³
                            await window.dialogClient.startRecording();
                        }
                        
                        // éšè—ä»‹ç»è¦†ç›–å±‚ï¼Œç›´æ¥è¿›å…¥æµ‹è¯•æµç¨‹
                        introOverlay.style.display = 'none';
                        controlsBar.style.display = 'flex';
                        updateProgress();
                        
                        if (state.mediaRecorder && state.mediaRecorder.state === 'inactive') {
                            state.mediaRecorder.start();
                        }
                        
                        // å¯åŠ¨ InteractionTracker
                        if (window.InteractionTracker) {
                            window.InteractionTracker.start();
                        }
                        
                        initTest();
                    } catch (error) {
                        console.error('è¿æ¥ WebSocket å¤±è´¥:', error);
                        alert('è¿æ¥è¯­éŸ³æœåŠ¡å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡å™¨æ˜¯å¦å·²å¯åŠ¨ã€‚');
                        enterBtn.disabled = false;
                        enterBtn.textContent = 'è¿›å…¥';
                    }
                };
            } catch (err) {
                console.error("éº¦å…‹é£æˆæƒå¤±è´¥:", err);
                alert("éœ€è¦éº¦å…‹é£æƒé™æ‰èƒ½å¼€å§‹æµ‹è¯•ã€‚è¯·åˆ·æ–°é¡µé¢å¹¶å…è®¸è®¿é—®ã€‚");
            }
        }

        function initTest() {
            // åˆå§‹åŒ–äº¤äº’è¿½è¸ªå™¨
            // æ³¨æ„ï¼šInteractionTracker.start() å·²åœ¨è¯­éŸ³æ’­æ”¾å®Œæˆåè°ƒç”¨ï¼Œè¿™é‡Œä¸å†é‡å¤è°ƒç”¨
            if (window.InteractionTracker) {
                window.InteractionTracker.init({
                    autoTrack: true,
                    trackZoom: true,
                    trackRotate: true,
                    trackDrawing: true,
                    trackNavigation: true,
                    includeTimestamp: false
                });
                // InteractionTracker.start() å·²åœ¨è¯­éŸ³æ’­æ”¾å®Œæˆçš„å›è°ƒä¸­è°ƒç”¨
                window.InteractionTracker._updateCurrentPlate(state.currentIndex);
            }
            
            loadImage(state.currentIndex);
            setupEventListeners();
            updateNavButtons();
            
            // ç¬¬ä¸€å¼ å›¾ç‰‡æ˜¾ç¤ºåï¼Œç«‹å³å¯åŠ¨"ä¸‹ä¸€å¼ "æŒ‰é’®çš„å†·å´æ—¶é—´
            // è¿™æ ·ç¡®ä¿ç”¨æˆ·ä»ç¬¬ä¸€å¼ å›¾ç‰‡å¼€å§‹å°±æœ‰å†·å´é™åˆ¶
            // æ³¨æ„ï¼šå¿…é¡»åœ¨ updateNavButtons() ä¹‹åè°ƒç”¨ï¼Œä»¥ç¡®ä¿å†·å´çŠ¶æ€ä¸ä¼šè¢«è¦†ç›–
            if (state.currentIndex === 0) {
                disableNextButton();
            }

            const resizeObserver = new ResizeObserver(() => {
                if (rorschachImage.complete && rorschachImage.naturalWidth > 0) {
                    resizeCanvas();
                    loadCanvasState(state.currentIndex);
                }
            });
            resizeObserver.observe(rorschachImage);

            // åˆå§‹åŒ–æ—¶ï¼Œå¦‚æœå›¾ç‰‡å·²åŠ è½½ï¼Œç«‹å³åŠ è½½ç”»å¸ƒçŠ¶æ€
            if (rorschachImage.complete) {
                resizeCanvas();
                loadCanvasState(state.currentIndex);
            } else {
                // å›¾ç‰‡åŠ è½½å®ŒæˆååŠ è½½ç”»å¸ƒçŠ¶æ€
                rorschachImage.onload = () => {
                    resizeCanvas();
                    loadCanvasState(state.currentIndex);
                    // ç§»é™¤äº‹ä»¶å¤„ç†å™¨ï¼Œé¿å…ä¸ loadImage ä¸­çš„å¤„ç†å™¨å†²çª
                    rorschachImage.onload = null;
                };
            }

            resetInactivityTimer();
        }

        function resizeCanvas() {
            canvas.width = rorschachImage.clientWidth;
            canvas.height = rorschachImage.clientHeight;
            canvas.style.width = rorschachImage.clientWidth + 'px';
            canvas.style.height = rorschachImage.clientHeight + 'px';
        }

        // éŸ³é¢‘å’Œè¯­éŸ³æ£€æµ‹
        function initAudio(stream) {
            state.mediaRecorder = new MediaRecorder(stream);
            state.mediaRecorder.ondataavailable = event => state.audioChunks.push(event.data);

            state.mediaRecorder.onstop = () => {
                const audioBlob = new Blob(state.audioChunks, { type: 'audio/webm' });
                
                // ä¿å­˜éŸ³é¢‘Blobåˆ°stateï¼Œä¾›finishAndSaveä½¿ç”¨
                state.audioBlob = audioBlob;
                
                const audioUrl = URL.createObjectURL(audioBlob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = audioUrl;
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                a.download = `rorschach_recording_${timestamp}.webm`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(audioUrl);
                state.audioChunks = [];
            };

            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const analyser = audioContext.createAnalyser();
            analyser.fftSize = 512;
            const source = audioContext.createMediaStreamSource(stream);
            source.connect(analyser);
            const dataArray = new Uint8Array(analyser.frequencyBinCount);

            function checkSpeaking() {
                analyser.getByteFrequencyData(dataArray);
                let sum = dataArray.reduce((a, b) => a + b, 0);
                if (sum / dataArray.length > 10) {
                    state.isSpeaking = true;
                    resetInactivityTimer();
                } else {
                    state.isSpeaking = false;
                }
                requestAnimationFrame(checkSpeaking);
            }
            checkSpeaking();
        }

        /**
         * æ’­æ”¾éŸ³é¢‘ï¼ˆæ”¯æŒæ–‡ä»¶è·¯å¾„å’Œå®æ—¶å¯¹è¯æ–‡æœ¬ï¼‰
         * @param {string} src - éŸ³é¢‘æ–‡ä»¶è·¯å¾„ï¼ˆå¦‚ 'audio/1.mp3'ï¼‰æˆ–æ–‡æœ¬å†…å®¹
         * @param {Function} onendedCallback - æ’­æ”¾å®Œæˆå›è°ƒ
         * @param {Object} options - å¯é€‰å‚æ•°
         */
        async function playAudio(src, onendedCallback = null, options = {}) {
            // å¦‚æœ src æ˜¯æ–‡ä»¶è·¯å¾„ï¼ˆä»¥ './audio/' æˆ– 'audio/' å¼€å¤´ï¼‰ï¼Œä½¿ç”¨åŸæœ‰æ–¹å¼æ’­æ”¾
            if (typeof src === 'string' && (src.startsWith('./audio/') || src.startsWith('audio/'))) {
                audioPlayer.src = src;
                audioPlayer.onended = onendedCallback;
                audioPlayer.play().catch(e => console.error("éŸ³é¢‘æ’­æ”¾å¤±è´¥:", e));
                return;
            }

            // å¦åˆ™ä½¿ç”¨å®æ—¶å¯¹è¯å®¢æˆ·ç«¯å‘é€æ–‡æœ¬æŸ¥è¯¢
            if (window.dialogClient) {
                try {
                    // ç¡®ä¿å·²è¿æ¥
                    if (!window.dialogClient.isConnected) {
                        await window.dialogClient.connect();
                    }

                    // å‘é€æ–‡æœ¬æŸ¥è¯¢ï¼ˆå·²æ³¨é‡Šï¼‰
                    // await window.dialogClient.sendTextQuery(src);

                    // ç”±äºå®æ—¶å¯¹è¯æ˜¯æµå¼æ’­æ”¾ï¼Œæ— æ³•å‡†ç¡®åˆ¤æ–­æ’­æ”¾å®Œæˆæ—¶é—´
                    // æ ¹æ®æ–‡æœ¬é•¿åº¦ä¼°ç®—æ’­æ”¾æ—¶é—´ï¼ˆå¹³å‡è¯­é€Ÿçº¦ 3-4 å­—/ç§’ï¼‰
                    if (onendedCallback) {
                        const estimatedDuration = Math.max(2000, src.length * 300); // è‡³å°‘ 2 ç§’ï¼Œæ¯å­—çº¦ 300ms
                        setTimeout(() => {
                            if (onendedCallback) {
                                onendedCallback();
                            }
                        }, estimatedDuration);
                    }
                } catch (error) {
                    console.error('[æ’­æ”¾éŸ³é¢‘] å®æ—¶å¯¹è¯å¤±è´¥:', error);
                    // é”™è¯¯å¤„ç†ï¼šæ˜¾ç¤ºæ–‡æœ¬æˆ–ä½¿ç”¨å…¶ä»–é™çº§æ–¹æ¡ˆ
                    if (options.onError) {
                        options.onError(error);
                    } else {
                        // é™çº§æ–¹æ¡ˆï¼šæ˜¾ç¤ºæ–‡æœ¬å†…å®¹
                        console.warn('[æ’­æ”¾éŸ³é¢‘] æ— æ³•æ’­æ”¾ï¼Œæ–‡æœ¬å†…å®¹:', src);
                    }
                }
            } else {
                console.warn('[æ’­æ”¾éŸ³é¢‘] å®æ—¶å¯¹è¯å®¢æˆ·ç«¯æœªåŠ è½½ï¼Œæ— æ³•æ’­æ”¾æ–‡æœ¬:', src);
                if (options.onError) {
                    options.onError(new Error('å®æ—¶å¯¹è¯å®¢æˆ·ç«¯æœªåŠ è½½'));
                }
            }
        }

        // ä¼˜åŒ–çš„ä¸æ´»åŠ¨é€»è¾‘
        function playRandomPrompt() {
            if (audioPlayer.paused && !state.isSpeaking) {
                if (state.inactivityLevel === 0) {
                    // ç¬¬ä¸€æ¬¡æç¤ºï¼šä½¿ç”¨TTSæ’­æ”¾éšæœºæç¤ºæ–‡æœ¬
                    const randomIndex = Math.floor(Math.random() * PROMPT_TEXTS.length);
                    const promptText = PROMPT_TEXTS[randomIndex];
                    showPromptIndicator(promptText);
                    playAudio(promptText, () => {
                        state.inactivityLevel = 1;
                        resetInactivityTimer();
                    });
                } else if (state.inactivityLevel === 1) {
                    // ç¬¬äºŒæ¬¡æç¤ºï¼šä½¿ç”¨TTSæ’­æ”¾æœ€ç»ˆæç¤ºæ–‡æœ¬
                    showPromptIndicator(FINAL_PROMPT_TEXT);
                    playAudio(FINAL_PROMPT_TEXT, () => {
                        state.inactivityLevel = 0;
                        resetInactivityTimer();
                    });
                }
            } else {
                resetInactivityTimer();
            }
        }

        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            state.inactivityLevel = 0;

            // ç¬¬ä¸€æ¬¡æç¤ºï¼š4ç§’
            inactivityTimer = setTimeout(() => {
                if (!state.isSpeaking && audioPlayer.paused) {
                    playRandomPrompt();
                }
            }, INACTIVITY_THRESHOLD_1);

            // ç¬¬äºŒæ¬¡æç¤ºï¼š8ç§’ï¼ˆåœ¨ç¬¬ä¸€æ¬¡åŸºç¡€ä¸Šå†4ç§’ï¼‰
            setTimeout(() => {
                if (state.inactivityLevel === 1 && !state.isSpeaking && audioPlayer.paused) {
                    playRandomPrompt();
                }
            }, INACTIVITY_THRESHOLD_2);
        }

        function showPromptIndicator(message) {
            const existing = document.querySelector('.prompt-indicator');
            if (existing) existing.remove();

            const indicator = document.createElement('div');
            indicator.className = 'prompt-indicator';
            indicator.textContent = message;
            document.body.appendChild(indicator);
            setTimeout(() => indicator.remove(), 3000);
        }

        // äº‹ä»¶ç›‘å¬å™¨
        // æ ‡è®°äº‹ä»¶ç›‘å¬å™¨æ˜¯å¦å·²ç»‘å®š
        let eventListenersSetup = false;
        
        function setupEventListeners() {
            // é˜²æ­¢é‡å¤ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            if (eventListenersSetup) {
                return;
            }
            eventListenersSetup = true;
            
            startTestBtn.addEventListener('click', startTest);
            prevBtn.addEventListener('click', () => navigate(-1));
            nextBtn.addEventListener('click', () => navigate(1));
            finishBtn.addEventListener('click', finishAndSave);

            document.getElementById('zoom-in-btn').addEventListener('click', () => {
                updateTransform({ zoom: state.zoom * 1.2 });
                resetInactivityTimer();
            });
            document.getElementById('zoom-out-btn').addEventListener('click', () => {
                updateTransform({ zoom: Math.max(0.2, state.zoom / 1.2) });
                resetInactivityTimer();
            });
            document.getElementById('rotate-left-btn').addEventListener('click', () => {
                updateTransform({ rotation: state.rotation - 30 });
                resetInactivityTimer();
            });
            document.getElementById('rotate-right-btn').addEventListener('click', () => {
                updateTransform({ rotation: state.rotation + 30 });
                resetInactivityTimer();
            });
            document.getElementById('pen-tool').addEventListener('click', () => {
                selectTool('pen');
                resetInactivityTimer();
            });
            document.getElementById('eraser-tool').addEventListener('click', () => {
                selectTool('eraser');
                resetInactivityTimer();
            });
            document.querySelectorAll('.color-option').forEach(opt => {
                opt.addEventListener('click', (e) => {
                    selectColor(e.target.dataset.color);
                    resetInactivityTimer();
                });
            });

            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
        }

        /**
         * ç¦ç”¨"ä¸‹ä¸€å¼ "æŒ‰é’®å¹¶å¼€å§‹å†·å´å€’è®¡æ—¶
         */
        function disableNextButton() {
            // å¦‚æœå·²ç»åœ¨å†·å´ä¸­ï¼Œç›´æ¥è¿”å›
            if (state.nextButtonCooldown > 0) {
                return;
            }

            // ç¦ç”¨æŒ‰é’®
            nextBtn.disabled = true;
            state.nextButtonCooldown = NEXT_BUTTON_COOLDOWN;

            // æ›´æ–°æŒ‰é’®æ–‡æœ¬æ˜¾ç¤ºå€’è®¡æ—¶
            function updateCooldownDisplay() {
                if (state.nextButtonCooldown > 0) {
                    nextBtn.textContent = `ä¸‹ä¸€å¼  â–¶ (${state.nextButtonCooldown}ç§’)`;
                    state.nextButtonCooldown--;
                } else {
                    // å†·å´ç»“æŸï¼Œæ¢å¤æŒ‰é’®
                    nextBtn.disabled = false;
                    nextBtn.textContent = 'ä¸‹ä¸€å¼  â–¶';
                    if (nextButtonCooldownTimer) {
                        clearInterval(nextButtonCooldownTimer);
                        nextButtonCooldownTimer = null;
                    }
                }
            }

            // ç«‹å³æ›´æ–°ä¸€æ¬¡æ˜¾ç¤º
            updateCooldownDisplay();

            // æ¯ç§’æ›´æ–°ä¸€æ¬¡å€’è®¡æ—¶
            nextButtonCooldownTimer = setInterval(updateCooldownDisplay, 1000);
        }

        // å¯¼èˆªå’ŒçŠ¶æ€
        function navigate(direction) {
            console.log('[è°ƒè¯•] navigate è¢«è°ƒç”¨:', {
                direction,
                currentIndex: state.currentIndex,
                newIndex: state.currentIndex + direction
            });
            
            saveCanvasState(state.currentIndex);
            const newIndex = state.currentIndex + direction;
            
            // å¦‚æœæ˜¯ç‚¹å‡»ä¸‹ä¸€å¼ ï¼Œæ£€æŸ¥æ˜¯å¦åœ¨å†·å´ä¸­
            // ä½†å¦‚æœæ˜¯æœ€åä¸€å¼ å›¾ï¼ˆå³å°†è¿›å…¥é€‰æ‹©é˜¶æ®µï¼‰ï¼Œå…è®¸æ“ä½œ
            if (direction === 1 && state.nextButtonCooldown > 0) {
                // å¦‚æœå³å°†è¿›å…¥é€‰æ‹©é˜¶æ®µï¼Œå…è®¸æ“ä½œå¹¶æ¸…é™¤å†·å´
                if (newIndex === state.totalImages) {
                    // æ¸…é™¤å†·å´å®šæ—¶å™¨
                    if (nextButtonCooldownTimer) {
                        clearInterval(nextButtonCooldownTimer);
                        nextButtonCooldownTimer = null;
                    }
                    state.nextButtonCooldown = 0;
                } else {
                    // åœ¨å†·å´ä¸­ä¸”ä¸æ˜¯æœ€åä¸€å¼ ï¼Œä¸å…è®¸æ“ä½œ
                    return;
                }
            }

            if (direction === 1 && newIndex === state.totalImages) {
                // è®°å½•æœ€åä¸€å¼ å›¾çš„å¯¼èˆªæ“ä½œï¼ˆè¿›å…¥é€‰æ‹©é˜¶æ®µï¼‰
                if (window.InteractionTracker && window.InteractionTracker._trackNavigation) {
                    window.InteractionTracker._trackNavigation('next');
                }
                
                // æ‰“å°æœ€åä¸€å¼ å›¾çš„æ•°æ®ï¼ˆç¦»å¼€å‰çš„å›¾ç‰ˆæ•°æ®ï¼‰
                if (window.InteractionTracker && window.InteractionTracker.printDataStructures) {
                    window.InteractionTracker.printDataStructures(state.currentIndex);
                }
                
                // æ¸…é™¤å†·å´å®šæ—¶å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                if (nextButtonCooldownTimer) {
                    clearInterval(nextButtonCooldownTimer);
                    nextButtonCooldownTimer = null;
                }
                state.nextButtonCooldown = 0;
                nextBtn.disabled = false;
                nextBtn.textContent = 'ä¸‹ä¸€å¼  â–¶';
                showPostTestView();
                return;
            }

            if (newIndex >= 0 && newIndex < state.totalImages) {
                // è®°å½•å¯¼èˆªæ“ä½œï¼ˆåœ¨åˆ‡æ¢ä¹‹å‰ï¼Œè®°å½•çš„æ˜¯å½“å‰å›¾ç‰ˆçš„å¯¼èˆªæ“ä½œï¼‰
                if (window.InteractionTracker && window.InteractionTracker._trackNavigation) {
                    window.InteractionTracker._trackNavigation(direction === 1 ? 'next' : 'prev');
                }
                
                // ä¿å­˜ç¦»å¼€å‰çš„å›¾ç‰ˆç´¢å¼•ï¼ˆç”¨äºæ‰“å°æ—¥å¿—ï¼‰
                const previousIndex = state.currentIndex;
                
                state.currentIndex = newIndex;
                console.log('[è°ƒè¯•] state.currentIndex æ›´æ–°ä¸º:', state.currentIndex);
                
                // æ›´æ–°è¿½è¸ªå™¨çš„å½“å‰å›¾ç‰ˆç´¢å¼•ï¼ˆè®°å½•æ—¶é—´æˆ³ï¼‰
                // æ³¨æ„ï¼šè¿™é‡Œè®°å½•çš„æ˜¯åˆ‡æ¢åˆ°æ–°å›¾ç‰ˆçš„æ—¶é—´ï¼Œå³æ–°å›¾ç‰ˆå¼€å§‹çš„æ—¶é—´
                if (window.InteractionTracker && window.InteractionTracker._updateCurrentPlate) {
                    window.InteractionTracker._updateCurrentPlate(state.currentIndex);
                }
                loadImage(state.currentIndex);
                updateProgress();
                
                console.log('[è°ƒè¯•] updateProgress åï¼ŒcurrentIndex:', state.currentIndex);
                
                // å¦‚æœæ˜¯ç‚¹å‡»ä¸‹ä¸€å¼ ï¼ˆåŒ…æ‹¬ä»ç¬¬ä¸€å¼ åˆ‡æ¢åˆ°ç¬¬äºŒå¼ ï¼‰ï¼Œåˆ‡æ¢åˆ°æ–°å›¾ç‰ˆåç«‹å³å¯åŠ¨å†·å´
                if (direction === 1) {
                    disableNextButton();
                    if (window.InteractionTracker && window.InteractionTracker.printDataStructures) {
                        window.InteractionTracker.printDataStructures(previousIndex);
                    }
                }
            }
            resetInactivityTimer();
        }

        function loadImage(index) {
            // æ³¨æ„ï¼šæ—¶é—´æˆ³å·²åœ¨ navigate() æˆ– startTest() ä¸­è®°å½•
            // è¿™é‡Œä¸éœ€è¦å†æ¬¡è®°å½•ï¼Œåªéœ€è¦ç¡®ä¿å›¾ç‰ˆç´¢å¼•åŒæ­¥
            if (window.InteractionTracker && window.InteractionTracker._updateCurrentPlate) {
                // åªæ›´æ–°ç´¢å¼•ï¼Œä¸è®°å½•æ—¶é—´æˆ³ï¼ˆå› ä¸ºå·²ç»è®°å½•è¿‡äº†ï¼‰
                window.InteractionTracker._updateCurrentPlate(index);
            }
            updateTransform({ zoom: 1, rotation: 0 }, true);
            
            // åˆ‡æ¢å›¾ç‰ˆæ—¶ç«‹å³æ¸…é™¤ç”»å¸ƒï¼ˆé¿å…æ˜¾ç¤ºä¸Šä¸€å¼ å›¾çš„è½¨è¿¹ï¼‰
            clearCanvas();
            
            // ç§»é™¤ä¹‹å‰çš„ onload äº‹ä»¶å¤„ç†å™¨ï¼Œé¿å…å†²çª
            rorschachImage.onload = null;
            
            rorschachImage.src = `./images/rorschach-blot-${index + 1}.png`;
            
            // ç¡®ä¿å›¾ç‰‡åŠ è½½ååŠ è½½è¯¥å›¾ç‰ˆçš„ç”»å¸ƒçŠ¶æ€
            if (rorschachImage.complete) {
                // å›¾ç‰‡å·²ç¼“å­˜ï¼Œç«‹å³åŠ è½½ç”»å¸ƒçŠ¶æ€
                resizeCanvas();
                loadCanvasState(index);
            } else {
                // å›¾ç‰‡éœ€è¦åŠ è½½ï¼Œç­‰å¾…åŠ è½½å®Œæˆ
                rorschachImage.onload = () => {
                    resizeCanvas();
                    loadCanvasState(index);
                };
            }
            
            updateNavButtons();
        }

        function updateNavButtons() {
            prevBtn.disabled = state.currentIndex === 0;
            // "ä¸‹ä¸€å¼ "æŒ‰é’®çš„ç¦ç”¨çŠ¶æ€ç”±å†·å´æ—¶é—´æ§åˆ¶
            // å¦‚æœæ˜¯æœ€åä¸€å¼ å›¾ï¼Œå§‹ç»ˆå…è®¸ç‚¹å‡»ï¼ˆè¿›å…¥é€‰æ‹©é˜¶æ®µä¸å—å†·å´é™åˆ¶ï¼‰
            if (state.currentIndex === state.totalImages - 1) {
                nextBtn.disabled = false;
                nextBtn.textContent = 'ä¸‹ä¸€å¼  â–¶';
            }
            // å…¶ä»–æƒ…å†µä¸‹ï¼Œç¦ç”¨çŠ¶æ€ç”±å†·å´å®šæ—¶å™¨æ§åˆ¶
        }

        function updateProgress() {
            console.log('[è°ƒè¯•] updateProgress è¢«è°ƒç”¨ï¼ŒcurrentIndex:', state.currentIndex, 'æ˜¾ç¤º:', state.currentIndex + 1);
            progressText.textContent = `ç¬¬ ${state.currentIndex + 1} / ${state.totalImages} å¼ å›¾ç‰‡`;
        }

        // åæµ‹è¯•è§†å›¾
        function showPostTestView() {
            clearTimeout(inactivityTimer);
            mainContent.style.display = 'none';
            controlsBar.style.display = 'none';
            postTestView.style.display = 'block';
            progressText.textContent = 'æµ‹è¯•æ€»ç»“é˜¶æ®µ';

            // è®°å½•è¿›å…¥é€‰æ‹©é˜¶æ®µçš„æ—¶é—´
            if (window.InteractionTracker && window.InteractionTracker.recordSelectPhase) {
                window.InteractionTracker.recordSelectPhase();
            }

            const grid = document.getElementById('post-test-grid');
            grid.innerHTML = '';
            for (let i = 0; i < state.totalImages; i++) {
                const item = document.createElement('div');
                item.className = 'grid-item';
                item.dataset.index = i;
                item.innerHTML = `<img src="./images/rorschach-blot-${i + 1}.png" alt="Image ${i + 1}"><h4>å›¾ ${i + 1}</h4>`;
                item.addEventListener('click', handleImageSelection);
                grid.appendChild(item);
            }
            askNextQuestion();
        }

        function askNextQuestion() {
            document.querySelectorAll('.grid-item.selected').forEach(el => el.classList.remove('selected'));

            if (currentQuestionIndex >= POST_TEST_QUESTIONS.length) {
                questionText.textContent = "æ‰€æœ‰é—®é¢˜å·²å›ç­”å®Œæ¯•ã€‚æ„Ÿè°¢æ‚¨çš„å‚ä¸ï¼";
                document.getElementById('post-test-grid').style.display = 'none';
                finishBtn.style.display = 'inline-block';
                return;
            }

            const question = POST_TEST_QUESTIONS[currentQuestionIndex];
            questionText.textContent = question.text;
            const gridContainer = document.getElementById('post-test-grid');

            gridContainer.style.pointerEvents = 'none';
            // ä½¿ç”¨TTSæ’­æ”¾é—®é¢˜æ–‡æœ¬ï¼ˆä½¿ç”¨question.textè€Œä¸æ˜¯question.audioï¼‰
            playAudio(question.text, () => {
                if (question.key !== 'mood') {
                    gridContainer.style.pointerEvents = 'auto';
                } else {
                    currentQuestionIndex++;
                    setTimeout(askNextQuestion, 1500);
                }
            });
        }

        function handleImageSelection(event) {
            const selectedIndex = event.currentTarget.dataset.index;
            const questionKey = POST_TEST_QUESTIONS[currentQuestionIndex].key;
            state.postTestAnswers[questionKey] = parseInt(selectedIndex) + 1;

            document.querySelectorAll('.grid-item.selected').forEach(el => el.classList.remove('selected'));
            event.currentTarget.classList.add('selected');

            currentQuestionIndex++;

            document.getElementById('post-test-grid').style.pointerEvents = 'none';
            setTimeout(askNextQuestion, 500);
        }

        // å®Œæˆå’Œæ±‡æ€»
        function finishAndSave() {
            if (state.mediaRecorder && state.mediaRecorder.state === 'recording') {
                state.mediaRecorder.stop();
            }
            
            // å¯¼å‡ºäº¤äº’è¿½è¸ªæ•°æ®
            if (window.InteractionTracker) {
                try {
                    window.InteractionTracker.stop();
                    
                    // è¾“å‡ºæ‰€æœ‰ç‰ˆå›¾çš„ç»Ÿè®¡ä¿¡æ¯ï¼ˆå®Œæ•´æ•°æ®ï¼‰
                    window.InteractionTracker.printAllPlatesStatistics();
                    
                    const interactionData = window.InteractionTracker.exportJSON({
                        pretty: true,
                        includeStats: true,
                        includeMetadata: true
                    });
                    console.log('[äº¤äº’è¿½è¸ªæ•°æ®]', JSON.parse(interactionData));
                    
                    // è·å–æ—‹è½¬æ¬¡æ•°ç»Ÿè®¡æ•°æ®ï¼ˆä»…è®°å½•åˆ°æ§åˆ¶å°ï¼Œä¸è‡ªåŠ¨å¯¼å‡ºï¼‰
                    const rotationCounts = window.InteractionTracker.getRotationCounts();
                    console.log('[æ—‹è½¬æ¬¡æ•°ç»Ÿè®¡]', rotationCounts);
                    
                    // è·å–ç”»ç¬”è½¨è¿¹æ•°æ®ï¼ˆä»…è®°å½•åˆ°æ§åˆ¶å°ï¼Œä¸è‡ªåŠ¨å¯¼å‡ºï¼‰
                    const drawingTracks = window.InteractionTracker.getDrawingTracks();
                    console.log('[ç”»ç¬”è½¨è¿¹æ•°æ®]', drawingTracks);
                    
                    // è·å–éŸ³é¢‘æ—¶é—´æˆ³ç»Ÿè®¡æ•°æ®ï¼ˆä»…è®°å½•åˆ°æ§åˆ¶å°ï¼Œä¸è‡ªåŠ¨å¯¼å‡ºï¼‰
                    const audioTimestamps = window.InteractionTracker.getAudioTimestamps();
                    console.log('[éŸ³é¢‘æ—¶é—´æˆ³ç»Ÿè®¡ï¼ˆç›¸å¯¹æ—¶é—´ï¼‰]', audioTimestamps);
                    
                    // è·å–ç»å¯¹æ—¶é—´æˆ³ç»Ÿè®¡æ•°æ®
                    const absoluteTimestamps = window.InteractionTracker.getAbsoluteTimestamps();
                    console.log('[ç»å¯¹æ—¶é—´æˆ³ç»Ÿè®¡]', absoluteTimestamps);
                    
                    // å¯é€‰ï¼šè‡ªåŠ¨ä¸‹è½½å®Œæ•´äº¤äº’æ•°æ®
                    // window.InteractionTracker.download('json');
                } catch (error) {
                    console.error('[äº¤äº’è¿½è¸ª] å¯¼å‡ºæ•°æ®å¤±è´¥:', error);
                }
            }
            
            // è°ƒç”¨æ¥å£æäº¤æ•°æ®åˆ°æœåŠ¡å™¨
            if (window.submitTestDataToServer && window.InteractionTracker) {
                // ä½¿ç”¨å¼‚æ­¥æ–¹å¼æäº¤ï¼Œä¸é˜»å¡é¡µé¢æ˜¾ç¤º
                (async () => {
                    try {
                        // æ˜¾ç¤ºæäº¤æç¤º
                        if (finishBtn) {
                            finishBtn.disabled = true;
                            finishBtn.textContent = 'æ­£åœ¨æäº¤æ•°æ®...';
                        }
                        
                        // è·å–éŸ³é¢‘æ•°æ®ï¼ˆä»state.audioBlobæˆ–é‡æ–°åˆ›å»ºï¼‰
                        let audioBlob = state.audioBlob;
                        if (!audioBlob && state.audioChunks && state.audioChunks.length > 0) {
                            audioBlob = new Blob(state.audioChunks, { type: 'audio/webm' });
                        }
                        
                        // è°ƒç”¨æ¥å£æäº¤æ•°æ®
                        const result = await window.submitTestDataToServer(
                            window.InteractionTracker,
                            audioBlob,
                            state.postTestAnswers
                        );
                        
                        console.log('[API] æ•°æ®æäº¤æˆåŠŸ:', result);
                        
                        // æ˜¾ç¤ºæˆåŠŸæç¤º
                        if (finishBtn) {
                            finishBtn.textContent = 'âœ… æ•°æ®å·²æäº¤æˆåŠŸ';
                            finishBtn.style.backgroundColor = '#10b981';
                        }
                    } catch (error) {
                        console.error('[API] æäº¤æ•°æ®å¤±è´¥:', error);
                        
                        // æ˜¾ç¤ºé”™è¯¯æç¤ºï¼ˆä¸å½±å“ç»§ç»­æ˜¾ç¤ºæ±‡æ€»é¡µé¢ï¼‰
                        if (finishBtn) {
                            finishBtn.textContent = 'âš ï¸ æ•°æ®æäº¤å¤±è´¥ï¼ˆå·²ä¿å­˜æœ¬åœ°ï¼‰';
                            finishBtn.style.backgroundColor = '#f59e0b';
                        }
                    }
                })();
            }
            
            showSummary();
        }

        function showSummary() {
            postTestView.style.display = 'none';
            summaryView.style.display = 'block';
            progressText.textContent = 'æµ‹è¯•å·²å®Œæˆï¼';

            const grid = document.getElementById('summary-grid');
            grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px; background: var(--primary-lighter); border-radius: 12px; margin-bottom: 20px;"><h3 style="color: var(--primary-color); margin: 0;">âœ… æ„Ÿè°¢æ‚¨çš„å‚ä¸ï¼æ‚¨çš„å½•éŸ³æ–‡ä»¶å·²å¼€å§‹ä¸‹è½½ã€‚</h3></div>';

            for (let i = 0; i < state.totalImages; i++) {
                const item = document.createElement('div');
                item.className = 'summary-item';
                item.innerHTML = `<h4>å›¾ ${i + 1}</h4>`;
                const compositeContainer = document.createElement('div');
                compositeContainer.style.position = 'relative';
                const baseImage = document.createElement('img');
                baseImage.src = `./images/rorschach-blot-${i + 1}.png`;
                compositeContainer.appendChild(baseImage);
                if (state.canvasStates[i]) {
                    const drawingImage = document.createElement('img');
                    drawingImage.src = state.canvasStates[i];
                    drawingImage.style.position = 'absolute';
                    drawingImage.style.top = 0;
                    drawingImage.style.left = 0;
                    drawingImage.style.width = '100%';
                    drawingImage.style.height = '100%';
                    compositeContainer.appendChild(drawingImage);
                }
                item.appendChild(compositeContainer);
                grid.appendChild(item);
            }
        }

        // ç»˜å›¾å’Œå˜æ¢
        function updateTransform(newTransforms = {}, force = false) {
            if (!force) {
                state.zoom = newTransforms.zoom !== undefined ? Math.max(0.2, newTransforms.zoom) : state.zoom;
                state.rotation = newTransforms.rotation !== undefined ? newTransforms.rotation : state.rotation;
            } else {
                state.zoom = newTransforms.zoom;
                state.rotation = newTransforms.rotation;
            }
            imageContainer.style.transform = `scale(${state.zoom}) rotate(${state.rotation}deg)`;
        }

        let lastX = 0, lastY = 0;

        function startDrawing(e) {
            state.drawing = true;
            const rect = canvas.getBoundingClientRect();
            lastX = e.clientX - rect.left;
            lastY = e.clientY - rect.top;
            
            // è¿½è¸ªç”»ç¬”è½¨è¿¹å¼€å§‹ï¼ˆä»…è®°å½•ç”»ç¬”ï¼Œä¸è®°å½•æ©¡çš®æ“¦ï¼‰
            if (state.tool === 'pen' && window.InteractionTracker && window.InteractionTracker._trackDrawingStart) {
                window.InteractionTracker._trackDrawingStart(lastX, lastY);
            }
            
            resetInactivityTimer();
        }

        function draw(e) {
            if (!state.drawing) return;
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            ctx.beginPath();
            if (state.tool === 'pen') {
                ctx.globalCompositeOperation = 'source-over';
                ctx.strokeStyle = state.color;
                ctx.lineWidth = 5;
            } else if (state.tool === 'eraser') {
                ctx.globalCompositeOperation = 'destination-out';
                ctx.lineWidth = 20;
            }
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.stroke();
            
            // è¿½è¸ªç”»ç¬”è½¨è¿¹ç‚¹ï¼ˆä»…è®°å½•ç”»ç¬”ï¼Œä¸è®°å½•æ©¡çš®æ“¦ï¼‰
            if (state.tool === 'pen' && window.InteractionTracker && window.InteractionTracker._trackDrawingPoint) {
                window.InteractionTracker._trackDrawingPoint(x, y);
            }
            
            lastX = x;
            lastY = y;
            resetInactivityTimer();
        }

        function stopDrawing() {
            state.drawing = false;
            
            // è¿½è¸ªç”»ç¬”è½¨è¿¹ç»“æŸï¼ˆä»…ç”»ç¬”æ¨¡å¼æ‰è®°å½•ï¼‰
            if (state.tool === 'pen' && window.InteractionTracker && window.InteractionTracker._trackDrawingEnd) {
                window.InteractionTracker._trackDrawingEnd();
            }
        }

        function selectTool(tool) {
            state.tool = tool;
            document.getElementById('pen-tool').classList.toggle('selected', tool === 'pen');
            document.getElementById('eraser-tool').classList.toggle('selected', tool === 'eraser');
        }

        function selectColor(color) {
            state.color = color;
            document.querySelectorAll('.color-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.color === color);
            });
            selectTool('pen');
        }

        function saveCanvasState(index) {
            if (canvas.width > 0 && canvas.height > 0) {
                state.canvasStates[index] = canvas.toDataURL();
            }
        }

        function loadCanvasState(index) {
            clearCanvas();
            const dataUrl = state.canvasStates[index];
            if (dataUrl) {
                const img = new Image();
                img.src = dataUrl;
                img.onload = () => ctx.drawImage(img, 0, 0);
            }
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', setupEventListeners);
    </script>
</body>
</html>