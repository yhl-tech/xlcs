worker_processes  1;

error_log  /root/jionlp_online/JioNLP_frontend/nginx/nginx_error.log warn;

# Change pid to allow no super user to run
# pid        /tmp/nginx.pid;
user root;

worker_rlimit_nofile 65535;
events {
    worker_connections  1024;
}

http {
    proxy_temp_path /tmp/proxy_temp;
    client_body_temp_path /tmp/client_temp;
    fastcgi_temp_path /tmp/fastcgi_temp;
    uwsgi_temp_path /tmp/uwsgi_temp;
    scgi_temp_path /tmp/scgi_temp;

    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /root/jionlp_online/JioNLP_frontend/nginx/nginx_access.log  main;

    sendfile        on;
    keepalive_timeout  60;

  server {  #监听端口
    server_name www.jionlp.com;  #域名
    root /root/jionlp_online/JioNLP_frontend/dist;  #站点目录

    gzip on;
    gzip_min_length 1k;
    gzip_buffers 4 16k;
    gzip_http_version 1.0;
    gzip_comp_level 9;
    gzip_types text/plain application/javascript application/x-javascript text/css text/javascript application/xml image/jpeg image/gif image/png;
    gzip_vary on;

    index index.html;

    location /blog_api/ {
        # 代理所有以 /blog_api/ 开头的请求到后端服务器
        proxy_pass http://0.0.0.0:16666/blog_api/;

        # 设置一些代理相关的参数
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location /jio_api/ {
        # 代理所有以 /blog_api/ 开头的请求到后端服务器
        proxy_pass http://0.0.0.0:16666/jio_api/;

        # 设置一些代理相关的参数
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location /blog_image/ {  # \d+/\w+\.(gif|jpg|jpeg|png|bmp|swf|ico)$
        # 代理所有以 /blog_api/ 开头的请求到后端服务器
        proxy_pass http://0.0.0.0:16666/blog_image/;

        # 设置一些代理相关的参数
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location /trivials/ {
        proxy_pass http://0.0.0.0:16666/trivials/;

        # 设置一些代理相关的参数
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        client_max_body_size 100m;
    }
    location / {
        root /root/jionlp_online/JioNLP_frontend/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
    }
 # 心理评估 xlpc 的 WebSocket 代理 (最终修正版)
    location /xlcp/ws/ {
        # 关键修改：在代理地址末尾添加了一个斜杠 "/"
        # 这会告诉 Nginx 将请求转发到后端的根路径 "/"
        proxy_pass http://127.0.0.1:8765/;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 保持长连接超时
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }
    # 心理评估 xlpc 的 location 配置
       location ^~ /xlcp {

        alias /root/xlpc/frontEnd/dist/;
        try_files $uri $uri/ /xlcp/index.html;
        index index.html;
    }
   
    # API 请求代理配置
    location /xlcp/api/ {
        # 将 API 请求转发到后端服务器
        proxy_pass http://14.103.237.160:29876/;
        
        # 设置请求头
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 设置超时时间
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
        
        # 允许跨域请求
        proxy_set_header Origin "";
    }
    location ~ .*\.(txt)$ {
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';
        add_header Access-Control-Allow-Headers 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization';

        if ($request_method = 'OPTIONS') {
            return 204;
        }
    }
    # location ~ .*\.(gif|jpg|jpeg|png|bmp|swf|ico)$
    # {
    #   expires 30d;
    #   # access_log off;
    # }
    location ~ .*\.(js|css)?$
    {
      expires 15d;
      # access_log off;
    }

    access_log on;
  
    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/www.jionlp.com/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/www.jionlp.com/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot

  
}

  server {
    if ($host = www.jionlp.com) {
        return 301 https://$host$request_uri;
    } # managed by Certbot

    listen 80;
    server_name www.jionlp.com;
    return 404; # managed by Certbot
  }

  # 心理评估 xlpc 的 HTTPS 配置
#   server {
#     # listen 80;
#     server_name www.jionlp.com;  # 替换为实际域名
#     root /root/xlpc/frontEnd/dist;

#     gzip on;
#     gzip_min_length 1k;
#     gzip_buffers 4 16k;
#     gzip_http_version 1.0;
#     gzip_comp_level 9;
#     gzip_types text/plain application/javascript application/x-javascript text/css text/javascript application/xml image/jpeg image/gif image/png;
#     gzip_vary on;

#     index index.html;

#     location / {
#         root /root/xlpc/frontEnd/dist;
#         index index.html;
#         try_files $uri $uri/ /index.html;
#     }

#     # WebSocket 代理示例：根据实际路径与后端地址修改
#     location /ws/ {
#         proxy_pass http://127.0.0.1:8765;

#         proxy_http_version 1.1;
#         proxy_set_header Upgrade $http_upgrade;
#         proxy_set_header Connection "upgrade";

#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;

#         proxy_read_timeout 60s;
#         proxy_send_timeout 60s;
#     }

#     location ~ .*\.(js|css)?$ {
#         expires 15d;
#     }

#     access_log on;
#     listen 443 ssl;
#     # 使用 certbot 为您的域名生成证书，然后取消下面的注释并修改路径
#     ssl_certificate /etc/letsencrypt/live/www.jionlp.com/fullchain.pem; # managed by Certbot
#     ssl_certificate_key /etc/letsencrypt/live/www.jionlp.com/privkey.pem; # managed by Certbot
#     include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
#     ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
#   }

#    server {
#     if ($host = www.jionlp.com) {
#         return 301 https://$host$request_uri;
#     } # managed by Certbot

#     listen 80;
#     server_name www.jionlp.com;
#     return 404; # managed by Certbot
#   }
}
