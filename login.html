<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç™»å½• - ç½—å¤å¢¨è¿¹æµ‹è¯•</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI",
          "Microsoft YaHei", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        padding: 20px;
      }

      .login-container {
        background: white;
        border-radius: 20px;
        padding: 50px 40px;
        box-shadow: 0 20px 25px rgba(0, 0, 0, 0.15);
        max-width: 450px;
        width: 100%;
        animation: slideUp 0.5s ease-out;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .login-container h1 {
        color: #1e3a8a;
        text-align: center;
        margin-bottom: 30px;
        font-size: 28px;
        font-weight: 700;
      }

      .form-group {
        margin-bottom: 20px;
      }

      .form-group label {
        display: block;
        font-size: 14px;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 8px;
      }

      .form-group input {
        width: 100%;
        padding: 12px 14px;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        font-size: 14px;
        transition: all 0.3s ease;
        background: #f9fafb;
      }

      .form-group input:focus {
        outline: none;
        border-color: #3b82f6;
        background: white;
        box-shadow: 0 0 0 3px #dbeafe;
      }

      .error-message {
        color: #ef4444;
        font-size: 13px;
        margin-top: 8px;
        display: none;
      }

      .error-message.show {
        display: block;
      }

      .success-message {
        color: #10b981;
        font-size: 13px;
        margin-top: 8px;
        display: none;
        text-align: center;
        padding: 10px;
        background: #d1fae5;
        border-radius: 8px;
        border: 1px solid #10b981;
      }

      .success-message.show {
        display: block;
      }

      #login-btn,
      #register-btn,
      #phone-login-btn {
        width: 100%;
        padding: 14px;
        margin-top: 30px;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      #login-btn:hover,
      #register-btn:hover,
      #phone-login-btn:hover {
        background: #1e3a8a;
        transform: translateY(-2px);
        box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
      }

      #login-btn:active,
      #register-btn:active,
      #phone-login-btn:active {
        transform: translateY(0);
      }

      #login-btn:disabled,
      #register-btn:disabled,
      #phone-login-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .loading {
        display: inline-block;
        width: 14px;
        height: 14px;
        border: 2px solid #ffffff;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spin 0.8s linear infinite;
        margin-right: 8px;
        vertical-align: middle;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .switch-form {
        text-align: center;
        margin-top: 20px;
        font-size: 14px;
        color: #6b7280;
      }

      .switch-form a {
        color: #3b82f6;
        text-decoration: none;
        font-weight: 600;
        cursor: pointer;
      }

      .switch-form a:hover {
        text-decoration: underline;
      }

      #register-form {
        display: none;
      }

      /* ç™»å½•æ–¹å¼åˆ‡æ¢æ ‡ç­¾ */
      .login-tabs {
        display: flex;
        margin-bottom: 30px;
        border-bottom: 2px solid #e2e8f0;
      }

      .login-tab {
        flex: 1;
        padding: 12px 20px;
        text-align: center;
        font-size: 15px;
        font-weight: 600;
        color: #6b7280;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        transition: all 0.3s ease;
        background: none;
        border-top: none;
        border-left: none;
        border-right: none;
      }

      .login-tab:hover {
        color: #3b82f6;
      }

      .login-tab.active {
        color: #3b82f6;
        border-bottom-color: #3b82f6;
      }

      /* æ‰‹æœºå·ç™»å½•è¡¨å• */
      #phone-login-form {
        display: none;
      }

      /* éªŒè¯ç è¾“å…¥ç»„ */
      .verification-code-group {
        display: flex;
        gap: 10px;
      }

      .verification-code-group .form-group {
        flex: 1;
        margin-bottom: 0;
      }

      .verification-code-group .form-group input {
        margin-bottom: 0;
      }

      #send-code-btn {
        padding: 12px 20px;
        background: #f3f4f6;
        color: #1f2937;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
        min-width: 120px;
      }

      #send-code-btn:hover:not(:disabled) {
        background: #e5e7eb;
        border-color: #d1d5db;
      }

      #send-code-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      #send-code-btn.countdown {
        background: #f9fafb;
        color: #9ca3af;
      }
    </style>
  </head>
  <body>
    <div class="login-container">
      <h1>ğŸ” ç”¨æˆ·ç™»å½•</h1>

      <!-- ç™»å½•æ–¹å¼åˆ‡æ¢æ ‡ç­¾ -->
      <div class="login-tabs">
        <button
          class="login-tab active"
          id="username-tab"
          data-form="username-login"
        >
          ç”¨æˆ·åç™»å½•
        </button>
        <button class="login-tab" id="phone-tab" data-form="phone-login">
          æ‰‹æœºå·ç™»å½•
        </button>
      </div>

      <!-- ç”¨æˆ·åç™»å½•è¡¨å• -->
      <form id="login-form">
        <div class="form-group">
          <label for="login-username">ç”¨æˆ·å</label>
          <input
            type="text"
            id="login-username"
            name="username"
            required
            autocomplete="username"
            placeholder="è¯·è¾“å…¥ç”¨æˆ·å"
          />
        </div>
        <div class="form-group">
          <label for="login-password">å¯†ç </label>
          <input
            type="password"
            id="login-password"
            name="password"
            required
            autocomplete="current-password"
            placeholder="è¯·è¾“å…¥å¯†ç "
          />
        </div>
        <div class="error-message" id="login-error-message"></div>
        <div class="success-message" id="login-success-message"></div>
        <button type="submit" id="login-btn">ç™»å½•</button>
      </form>

      <!-- æ‰‹æœºå·ç™»å½•è¡¨å• -->
      <form id="phone-login-form">
        <div class="form-group">
          <label for="phone-number">æ‰‹æœºå·</label>
          <input
            type="tel"
            id="phone-number"
            name="phone"
            required
            autocomplete="tel"
            placeholder="è¯·è¾“å…¥æ‰‹æœºå·"
            maxlength="11"
          />
        </div>
        <div class="form-group">
          <label for="verification-code">éªŒè¯ç </label>
          <div class="verification-code-group">
            <div class="form-group">
              <input
                type="text"
                id="verification-code"
                name="verification_code"
                required
                autocomplete="off"
                placeholder="è¯·è¾“å…¥éªŒè¯ç "
                maxlength="6"
              />
            </div>
            <button type="button" id="send-code-btn">å‘é€éªŒè¯ç </button>
          </div>
        </div>
        <div class="error-message" id="phone-login-error-message"></div>
        <div class="success-message" id="phone-login-success-message"></div>
        <button type="submit" id="phone-login-btn">ç™»å½•</button>
      </form>

      <form id="register-form">
        <div class="form-group">
          <label for="register-username">ç”¨æˆ·å</label>
          <input
            type="text"
            id="register-username"
            name="username"
            required
            autocomplete="username"
            placeholder="è¯·è¾“å…¥ç”¨æˆ·å"
          />
        </div>
        <div class="form-group">
          <label for="register-password">å¯†ç </label>
          <input
            type="password"
            id="register-password"
            name="password"
            required
            autocomplete="new-password"
            placeholder="è¯·è¾“å…¥å¯†ç "
          />
        </div>
        <div class="form-group">
          <label for="register-confirm-password">ç¡®è®¤å¯†ç </label>
          <input
            type="password"
            id="register-confirm-password"
            name="confirm-password"
            required
            autocomplete="new-password"
            placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç "
          />
        </div>
        <div class="error-message" id="register-error-message"></div>
        <div class="success-message" id="register-success-message"></div>
        <button type="submit" id="register-btn">æ³¨å†Œ</button>
      </form>

      <div class="switch-form">
        <span id="switch-text">æ²¡æœ‰è´¦æˆ·ï¼Ÿ</span>
        <a id="switch-link">ç«‹å³æ³¨å†Œ</a>
      </div>
    </div>

    <!-- Axios åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <!-- é…ç½®æ–‡ä»¶ -->
    <script type="module" src="./script/config.js"></script>

    <!-- API æ¥å£æ¨¡å— -->
    <script type="module" src="./script/api.js"></script>

    <!-- è®¤è¯æ¨¡å— -->
    <script type="module" src="./script/auth.js"></script>

    <script>
      // ç­‰å¾…æ¨¡å—åŠ è½½å®Œæˆ
      function waitForModules(callback, maxRetries = 50) {
        let retries = 0
        const checkModules = () => {
          if (window.auth && window.apiClient) {
            callback()
          } else if (retries < maxRetries) {
            retries++
            setTimeout(checkModules, 100)
          } else {
            console.error("æ¨¡å—åŠ è½½è¶…æ—¶")
            const errorMsg = document.getElementById("login-error-message")
            if (errorMsg) {
              errorMsg.textContent = "ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•"
              errorMsg.classList.add("show")
            }
          }
        }
        checkModules()
      }

      // åˆå§‹åŒ–ç™»å½•é¡µé¢
      function initLoginPage() {
        // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
        if (window.auth && window.auth.isLoggedIn()) {
          // å·²ç™»å½•ï¼Œç›´æ¥è·³è½¬åˆ°ä¸»é¡µ
          window.location.href = "./index.html"
          return
        }

        const loginForm = document.getElementById("login-form")
        const phoneLoginForm = document.getElementById("phone-login-form")
        const registerForm = document.getElementById("register-form")
        const switchLink = document.getElementById("switch-link")
        const switchText = document.getElementById("switch-text")
        const loginBtn = document.getElementById("login-btn")
        const phoneLoginBtn = document.getElementById("phone-login-btn")
        const registerBtn = document.getElementById("register-btn")
        const loginErrorMessage = document.getElementById("login-error-message")
        const phoneLoginErrorMessage = document.getElementById(
          "phone-login-error-message"
        )
        const registerErrorMessage = document.getElementById(
          "register-error-message"
        )
        const loginSuccessMessage = document.getElementById(
          "login-success-message"
        )
        const phoneLoginSuccessMessage = document.getElementById(
          "phone-login-success-message"
        )
        const registerSuccessMessage = document.getElementById(
          "register-success-message"
        )

        // ç™»å½•æ–¹å¼åˆ‡æ¢æ ‡ç­¾
        const usernameTab = document.getElementById("username-tab")
        const phoneTab = document.getElementById("phone-tab")
        const loginTabs = document.querySelector(".login-tabs")
        const sendCodeBtn = document.getElementById("send-code-btn")
        const phoneNumberInput = document.getElementById("phone-number")
        const verificationCodeInput =
          document.getElementById("verification-code")

        // éªŒè¯ç å€’è®¡æ—¶ç›¸å…³
        let countdownTimer = null
        let countdownSeconds = 0

        // è®°å½•å½“å‰ç™»å½•æ–¹å¼ï¼ˆç”¨äºä»æ³¨å†Œè¡¨å•åˆ‡æ¢å›ç™»å½•è¡¨å•æ—¶æ¢å¤ï¼‰
        let currentLoginType = "username" // 'username' æˆ– 'phone'

        // æ‰‹æœºå·æ ¼å¼éªŒè¯
        function validatePhone(phone) {
          return /^1[3-9]\d{9}$/.test(phone)
        }

        // å¯åŠ¨éªŒè¯ç å€’è®¡æ—¶
        function startCountdown(seconds = 60) {
          countdownSeconds = seconds
          sendCodeBtn.disabled = true
          sendCodeBtn.classList.add("countdown")

          countdownTimer = setInterval(() => {
            countdownSeconds--
            sendCodeBtn.textContent = `${countdownSeconds}ç§’åé‡è¯•`

            if (countdownSeconds <= 0) {
              clearInterval(countdownTimer)
              countdownTimer = null
              sendCodeBtn.disabled = false
              sendCodeBtn.classList.remove("countdown")
              sendCodeBtn.textContent = "å‘é€éªŒè¯ç "
            }
          }, 1000)
        }

        // åœæ­¢å€’è®¡æ—¶
        function stopCountdown() {
          if (countdownTimer) {
            clearInterval(countdownTimer)
            countdownTimer = null
          }
          sendCodeBtn.disabled = false
          sendCodeBtn.classList.remove("countdown")
          sendCodeBtn.textContent = "å‘é€éªŒè¯ç "
        }

        // ç™»å½•æ–¹å¼åˆ‡æ¢
        usernameTab.addEventListener("click", () => {
          currentLoginType = "username"
          usernameTab.classList.add("active")
          phoneTab.classList.remove("active")
          loginForm.style.display = "block"
          phoneLoginForm.style.display = "none"
          hideLoginMessages()
          hidePhoneLoginMessages()
        })

        phoneTab.addEventListener("click", () => {
          currentLoginType = "phone"
          phoneTab.classList.add("active")
          usernameTab.classList.remove("active")
          loginForm.style.display = "none"
          phoneLoginForm.style.display = "block"
          hideLoginMessages()
          hidePhoneLoginMessages()
        })

        // å‘é€éªŒè¯ç 
        sendCodeBtn.addEventListener("click", async () => {
          const phone = phoneNumberInput.value.trim()

          if (!phone) {
            showPhoneLoginError("è¯·è¾“å…¥æ‰‹æœºå·")
            return
          }

          if (!validatePhone(phone)) {
            showPhoneLoginError("è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·æ ¼å¼")
            return
          }

          // ç¦ç”¨æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
          sendCodeBtn.disabled = true
          const originalText = sendCodeBtn.textContent
          sendCodeBtn.textContent = "å‘é€ä¸­..."
          hidePhoneLoginError()

          try {
            if (
              window.API &&
              typeof window.API.sendVerificationCode === "function"
            ) {
              const response = await window.API.sendVerificationCode(phone)

              if (response.code === 0) {
                // å‘é€æˆåŠŸï¼Œå¯åŠ¨å€’è®¡æ—¶
                startCountdown(60)
                showPhoneLoginSuccess("éªŒè¯ç å·²å‘é€ï¼Œè¯·æŸ¥æ”¶çŸ­ä¿¡")
              } else {
                showPhoneLoginError(
                  response.exception ||
                    response.msg ||
                    "éªŒè¯ç å‘é€å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•"
                )
                sendCodeBtn.disabled = false
                sendCodeBtn.textContent = originalText
              }
            } else {
              throw new Error("å‘é€éªŒè¯ç æ¥å£æœªåˆå§‹åŒ–")
            }
          } catch (error) {
            console.error("å‘é€éªŒè¯ç é”™è¯¯:", error)
            showPhoneLoginError(error.message || "éªŒè¯ç å‘é€å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•")
            sendCodeBtn.disabled = false
            sendCodeBtn.textContent = originalText
          }
        })

        // æ‰‹æœºå·è¾“å…¥é™åˆ¶ï¼ˆåªå…è®¸æ•°å­—ï¼‰
        phoneNumberInput.addEventListener("input", (e) => {
          e.target.value = e.target.value.replace(/\D/g, "")
          hidePhoneLoginError()
        })

        // éªŒè¯ç è¾“å…¥é™åˆ¶ï¼ˆåªå…è®¸æ•°å­—ï¼‰
        verificationCodeInput.addEventListener("input", (e) => {
          e.target.value = e.target.value.replace(/\D/g, "")
          hidePhoneLoginError()
        })

        // æ‰‹æœºå·ç™»å½•è¡¨å•æäº¤
        phoneLoginForm.addEventListener("submit", async (e) => {
          e.preventDefault()

          const phone = phoneNumberInput.value.trim()
          const verificationCode = verificationCodeInput.value.trim()

          if (!phone) {
            showPhoneLoginError("è¯·è¾“å…¥æ‰‹æœºå·")
            return
          }

          if (!validatePhone(phone)) {
            showPhoneLoginError("è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·æ ¼å¼")
            return
          }

          if (!verificationCode) {
            showPhoneLoginError("è¯·è¾“å…¥éªŒè¯ç ")
            return
          }

          if (verificationCode.length !== 6) {
            showPhoneLoginError("éªŒè¯ç ä¸º6ä½æ•°å­—")
            return
          }

          // ç¦ç”¨æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
          phoneLoginBtn.disabled = true
          phoneLoginBtn.innerHTML = '<span class="loading"></span>ç™»å½•ä¸­...'
          hidePhoneLoginError()

          try {
            if (
              window.auth &&
              typeof window.auth.loginWithPhone === "function"
            ) {
              const result = await window.auth.loginWithPhone(
                phone,
                verificationCode
              )

              if (result.success) {
                // è·³è½¬åˆ°ä¸»é¡µ
                window.location.href = "./index.html"
              } else {
                // ç™»å½•å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                showPhoneLoginError(
                  result.message || "ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ‰‹æœºå·å’ŒéªŒè¯ç "
                )
                phoneLoginBtn.disabled = false
                phoneLoginBtn.textContent = "ç™»å½•"
              }
            } else {
              throw new Error("æ‰‹æœºå·ç™»å½•åŠŸèƒ½æœªåˆå§‹åŒ–")
            }
          } catch (error) {
            console.error("æ‰‹æœºå·ç™»å½•é”™è¯¯:", error)
            showPhoneLoginError(error.message || "ç™»å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•")
            phoneLoginBtn.disabled = false
            phoneLoginBtn.textContent = "ç™»å½•"
          }
        })

        // åˆ‡æ¢è¡¨å•
        switchLink.addEventListener("click", () => {
          if (
            loginForm.style.display !== "none" ||
            phoneLoginForm.style.display !== "none"
          ) {
            // åˆ‡æ¢åˆ°æ³¨å†Œè¡¨å•
            loginForm.style.display = "none"
            phoneLoginForm.style.display = "none"
            registerForm.style.display = "block"
            loginTabs.style.display = "none" // éšè—ç™»å½•æ–¹å¼æ ‡ç­¾
            switchText.innerHTML = "å·²æœ‰è´¦æˆ·ï¼Ÿ"
            switchLink.textContent = "ç«‹å³ç™»å½•"
            document.querySelector(".login-container h1").textContent =
              "ğŸ“ ç”¨æˆ·æ³¨å†Œ"
            hideRegisterMessages()
            hideLoginMessages()
            hidePhoneLoginMessages()
          } else {
            // åˆ‡æ¢åˆ°ç™»å½•è¡¨å•ï¼Œæ¢å¤ä¹‹å‰é€‰æ‹©çš„ç™»å½•æ–¹å¼
            registerForm.style.display = "none"
            loginTabs.style.display = "flex" // æ˜¾ç¤ºç™»å½•æ–¹å¼æ ‡ç­¾
            switchText.innerHTML = "æ²¡æœ‰è´¦æˆ·ï¼Ÿ"
            switchLink.textContent = "ç«‹å³æ³¨å†Œ"
            document.querySelector(".login-container h1").textContent =
              "ğŸ” ç”¨æˆ·ç™»å½•"
            hideRegisterMessages()

            // æ ¹æ®è®°å½•çš„ç™»å½•æ–¹å¼æ˜¾ç¤ºå¯¹åº”çš„è¡¨å•
            if (currentLoginType === "phone") {
              phoneTab.classList.add("active")
              usernameTab.classList.remove("active")
              loginForm.style.display = "none"
              phoneLoginForm.style.display = "block"
            } else {
              usernameTab.classList.add("active")
              phoneTab.classList.remove("active")
              loginForm.style.display = "block"
              phoneLoginForm.style.display = "none"
            }
          }
        })

        // ç™»å½•è¡¨å•æäº¤
        loginForm.addEventListener("submit", async (e) => {
          e.preventDefault()

          const username = document
            .getElementById("login-username")
            .value.trim()
          const password = document.getElementById("login-password").value

          if (!username || !password) {
            showLoginError("è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ")
            return
          }

          // ç¦ç”¨æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
          loginBtn.disabled = true
          loginBtn.innerHTML = '<span class="loading"></span>ç™»å½•ä¸­...'
          hideLoginError()

          try {
            const result = await window.auth.login(username, password)

            if (result.success) {
              // è·³è½¬åˆ°ä¸»é¡µ
              window.location.href = "./index.html"
            } else {
              // ç™»å½•å¤±è´¥ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
              showLoginError(result.message || "ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·åå’Œå¯†ç ")
              loginBtn.disabled = false
              loginBtn.textContent = "ç™»å½•"
            }
          } catch (error) {
            console.error("ç™»å½•é”™è¯¯:", error)
            showLoginError(error.message || "ç™»å½•å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•")
            loginBtn.disabled = false
            loginBtn.textContent = "ç™»å½•"
          }
        })

        // æ³¨å†Œè¡¨å•æäº¤
        registerForm.addEventListener("submit", async (e) => {
          e.preventDefault()

          const username = document
            .getElementById("register-username")
            .value.trim()
          const password = document.getElementById("register-password").value
          const confirmPassword = document.getElementById(
            "register-confirm-password"
          ).value

          // éªŒè¯è¾“å…¥
          if (!username || !password || !confirmPassword) {
            showRegisterError("è¯·å¡«å†™æ‰€æœ‰å­—æ®µ")
            return
          }

          if (password !== confirmPassword) {
            showRegisterError("ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´")
            return
          }

          if (password.length < 6) {
            showRegisterError("å¯†ç é•¿åº¦è‡³å°‘ä¸º6ä½")
            return
          }

          // ç¦ç”¨æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
          registerBtn.disabled = true
          registerBtn.innerHTML = '<span class="loading"></span>æ³¨å†Œä¸­...'
          hideRegisterError()

          try {
            // è°ƒç”¨APIæ¨¡å—ä¸­çš„æ³¨å†Œæ–¹æ³•
            const response = await window.API.register(username, password)

            if (response.code === 0) {
              // æ³¨å†ŒæˆåŠŸï¼Œè‡ªåŠ¨ç™»å½•
              showRegisterSuccess("æ³¨å†ŒæˆåŠŸï¼æ­£åœ¨ç™»å½•...")
              registerBtn.disabled = false
              registerBtn.textContent = "æ³¨å†ŒæˆåŠŸ"

              // å¦‚æœè¿”å›äº†access_tokenï¼Œç›´æ¥ç™»å½•
              if (response.data?.access_token) {
                // ä¿å­˜ token å’Œç”¨æˆ·ä¿¡æ¯
                window.auth.setToken(response.data.access_token)
                window.auth.setUserInfo({ username: username })

                // æ³¨å†ŒæˆåŠŸåï¼Œæ‰§è¡Œç§Ÿæˆ·ç™»å½•ä»¥åˆ·æ–° analyzeApiKey
                try {
                  if (
                    window.API &&
                    typeof window.API.tenantLogin === "function"
                  ) {
                    const tenantResult = await window.API.tenantLogin()
                    if (!tenantResult?.success) {
                      console.warn(
                        "[æ³¨å†Œ] ç§Ÿæˆ·ç™»å½•å¤±è´¥:",
                        tenantResult?.message
                      )
                      // ç§Ÿæˆ·ç™»å½•å¤±è´¥ä¸å½±å“æ³¨å†ŒæˆåŠŸï¼Œä½†ä¼šè®°å½•è­¦å‘Š
                    }
                  }
                } catch (error) {
                  console.warn("[æ³¨å†Œ] ç§Ÿæˆ·ç™»å½•å¼‚å¸¸:", error)
                  // ç§Ÿæˆ·ç™»å½•å¼‚å¸¸ä¸å½±å“æ³¨å†ŒæˆåŠŸï¼Œä½†ä¼šè®°å½•è­¦å‘Š
                }

                // å»¶è¿Ÿ1ç§’åè·³è½¬åˆ°ä¸»é¡µ
                setTimeout(() => {
                  window.location.href = "./index.html"
                }, 1000)
              } else {
                // å¦‚æœæ²¡æœ‰è¿”å›tokenï¼Œåˆ‡æ¢åˆ°ç™»å½•è¡¨å•
                setTimeout(() => {
                  registerForm.style.display = "none"
                  loginForm.style.display = "block"
                  switchText.innerHTML = "æ²¡æœ‰è´¦æˆ·ï¼Ÿ"
                  switchLink.textContent = "ç«‹å³æ³¨å†Œ"
                  document.querySelector(".login-container h1").textContent =
                    "ğŸ” ç”¨æˆ·ç™»å½•"
                  hideRegisterMessages()

                  // è‡ªåŠ¨å¡«å……ç”¨æˆ·å
                  document.getElementById("login-username").value = username
                  registerBtn.textContent = "æ³¨å†Œ"
                }, 3000)
              }
            } else {
              // æ³¨å†Œå¤±è´¥ï¼Œä¼˜å…ˆä½¿ç”¨ exception å­—æ®µï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ msg å­—æ®µ
              showRegisterError(
                response.exception || response.msg || "æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•"
              )
              registerBtn.disabled = false
              registerBtn.textContent = "æ³¨å†Œ"
            }
          } catch (error) {
            console.error("æ³¨å†Œé”™è¯¯:", error)
            showRegisterError(error.message || "æ³¨å†Œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•")
            registerBtn.disabled = false
            registerBtn.textContent = "æ³¨å†Œ"
          }
        })

        function showLoginError(message) {
          loginErrorMessage.textContent = message
          loginErrorMessage.classList.add("show")
        }

        function hideLoginError() {
          loginErrorMessage.classList.remove("show")
        }

        function showLoginSuccess(message) {
          loginSuccessMessage.textContent = message
          loginSuccessMessage.classList.add("show")
        }

        function hideLoginMessages() {
          loginErrorMessage.classList.remove("show")
          loginSuccessMessage.classList.remove("show")
        }

        function showPhoneLoginError(message) {
          phoneLoginErrorMessage.textContent = message
          phoneLoginErrorMessage.classList.add("show")
        }

        function hidePhoneLoginError() {
          phoneLoginErrorMessage.classList.remove("show")
        }

        function showPhoneLoginSuccess(message) {
          phoneLoginSuccessMessage.textContent = message
          phoneLoginSuccessMessage.classList.add("show")
          // 3ç§’åè‡ªåŠ¨éšè—
          setTimeout(() => {
            hidePhoneLoginSuccess()
          }, 3000)
        }

        function hidePhoneLoginSuccess() {
          phoneLoginSuccessMessage.classList.remove("show")
        }

        function hidePhoneLoginMessages() {
          phoneLoginErrorMessage.classList.remove("show")
          phoneLoginSuccessMessage.classList.remove("show")
        }

        function showRegisterError(message) {
          registerErrorMessage.textContent = message
          registerErrorMessage.classList.add("show")
        }

        function hideRegisterError() {
          registerErrorMessage.classList.remove("show")
        }

        function showRegisterSuccess(message) {
          registerSuccessMessage.textContent = message
          registerSuccessMessage.classList.add("show")
        }

        function hideRegisterMessages() {
          registerErrorMessage.classList.remove("show")
          registerSuccessMessage.classList.remove("show")
        }

        // è¾“å…¥æ—¶æ¸…é™¤é”™è¯¯ä¿¡æ¯
        document
          .getElementById("login-username")
          .addEventListener("input", hideLoginError)
        document
          .getElementById("login-password")
          .addEventListener("input", hideLoginError)
        document
          .getElementById("register-username")
          .addEventListener("input", hideRegisterError)
        document
          .getElementById("register-password")
          .addEventListener("input", hideRegisterError)
        document
          .getElementById("register-confirm-password")
          .addEventListener("input", hideRegisterError)

        // é¡µé¢å¸è½½æ—¶æ¸…é™¤å€’è®¡æ—¶
        window.addEventListener("beforeunload", () => {
          stopCountdown()
        })
      }

      // ç­‰å¾…æ¨¡å—åŠ è½½å®Œæˆååˆå§‹åŒ–
      waitForModules(initLoginPage)
    </script>
  </body>
</html>
